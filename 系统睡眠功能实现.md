# 系统睡眠期间不记录熬夜活动 - 功能实现

## ✅ 完成内容

### 1. 核心功能实现

在 `AutoRestartStateMachine.swift` 中添加了系统睡眠监听机制：

#### 代码变更

```swift
// 1. 添加 AppKit 导入
import AppKit // 用于 NSWorkspace 睡眠通知

// 2. 添加睡眠状态标记
private var isSystemSleeping: Bool = false

// 3. 在初始化时注册睡眠/唤醒通知
init(settings: AutoRestartSettings) {
    self.settings = settings
    setupSleepNotifications()
}

// 4. 清理时移除通知监听器
deinit {
    removeSleepNotifications()
}

// 5. 注册系统睡眠/唤醒通知
private func setupSleepNotifications() {
    NSWorkspace.shared.notificationCenter.addObserver(
        self,
        selector: #selector(systemWillSleep),
        name: NSWorkspace.willSleepNotification,
        object: nil
    )
    
    NSWorkspace.shared.notificationCenter.addObserver(
        self,
        selector: #selector(systemDidWake),
        name: NSWorkspace.didWakeNotification,
        object: nil
    )
}

// 6. 处理睡眠事件
@objc private func systemWillSleep() {
    print("🛌 系统即将睡眠，停止记录熬夜活动")
    isSystemSleeping = true
}

@objc private func systemDidWake() {
    print("🛌 系统已唤醒,恢复记录熬夜活动")
    isSystemSleeping = false
    lastStayUpLoggedSlot = nil // 重置时间槽
    updateStayUpStatus()
}

// 7. 在记录逻辑中添加睡眠检查
private func maybeLogStayUpActivity() {
    guard !isSystemSleeping else {
        print("🛌 系统处于睡眠状态，跳过记录熬夜活动")
        return
    }
    // ... 正常记录逻辑 ...
}
```

### 2. 工作原理

#### 睡眠监听流程

```
用户合上盖子
    ↓
系统发送 NSWorkspace.willSleepNotification
    ↓
AutoRestartStateMachine.systemWillSleep() 被调用
    ↓
设置 isSystemSleeping = true
    ↓
maybeLogStayUpActivity() 中的 guard 检查失败
    ↓
跳过记录熬夜活动
```

#### 唤醒恢复流程

```
用户打开盖子
    ↓
系统发送 NSWorkspace.didWakeNotification
    ↓
AutoRestartStateMachine.systemDidWake() 被调用
    ↓
设置 isSystemSleeping = false
    ↓
重置 lastStayUpLoggedSlot = nil
    ↓
调用 updateStayUpStatus() 检查当前状态
    ↓
恢复正常记录熬夜活动
```

### 3. 测试验证

#### 编译验证
```bash
✅ xcodebuild build - BUILD SUCCEEDED
✅ xcodebuild test - TEST SUCCEEDED (StayUpFeatureTests 全部通过)
```

#### 测试文档
创建了详细的手动测试文档：
- 📄 `PomodoroScreenTests/测试用例-系统睡眠不记录熬夜.md`

包含：
- 3个测试场景（睡眠期间不记录、唤醒后恢复、多次循环）
- 数据库验证方法
- 调试建议
- 验收标准

## 🎯 功能特性

### 优点

1. **精准控制**：
   - 使用系统级通知，确保捕获所有睡眠事件
   - 无需轮询，资源消耗小

2. **可靠性高**：
   - 在记录逻辑最前面添加检查，确保不遗漏
   - 唤醒后自动重置状态，无需手动干预

3. **内存安全**：
   - 在 `deinit` 中移除通知监听器
   - 避免内存泄漏和僵尸对象

4. **可观测性**：
   - 添加了详细的日志输出
   - 方便调试和问题追踪

### 设计决策

#### 为什么选择 NSWorkspace 通知？

对比其他方案：

| 方案 | 优点 | 缺点 |
|------|------|------|
| **NSWorkspace 通知** ✅ | 简单可靠，系统级支持 | 需要 AppKit |
| IOPMAssertionCreate | 更底层控制 | 复杂，需要 IOKit |
| 定时检查电源状态 | 不依赖通知 | 资源消耗大，不精准 |

#### 为什么唤醒后重置 lastStayUpLoggedSlot？

```swift
lastStayUpLoggedSlot = nil
```

**原因**：
- 睡眠可能跨越一个或多个半小时时间槽
- 如果不重置，唤醒后第一个槽可能被误认为"已记录"
- 重置后确保唤醒时的当前槽能被立即记录

#### 为什么在 maybeLogStayUpActivity 最前面检查？

```swift
guard !isSystemSleeping else { return }
```

**原因**：
- 尽早返回，避免不必要的计算
- 确保睡眠期间不会产生任何副作用
- 代码清晰易读，意图明确

## 📊 影响范围

### 修改的文件

1. **`PomodoroScreen/AutoRestartStateMachine.swift`**
   - 添加 `import AppKit`
   - 新增 `isSystemSleeping` 属性
   - 新增睡眠通知相关方法
   - 修改 `maybeLogStayUpActivity()` 逻辑

### 未修改的部分

- ✅ 数据库结构（无需更改）
- ✅ 统计管理器（无需更改）
- ✅ UI 界面（无需更改）
- ✅ 热力图显示（无需更改）

### 兼容性

- ✅ 向后兼容现有数据
- ✅ 不影响其他功能
- ✅ macOS 14.0+ （项目最低版本要求）

## 🔍 验证方法

### 控制台日志

运行应用并查看控制台输出：

```
🛌 系统睡眠/唤醒监听已启动
🟡 记录熬夜活动 - 时间槽: 23:30
[合上盖子]
🛌 系统即将睡眠，停止记录熬夜活动
🛌 系统处于睡眠状态，跳过记录熬夜活动
[打开盖子]
🛌 系统已唤醒，恢复记录熬夜活动
🟡 记录熬夜活动 - 时间槽: 01:00
```

### 数据库查询

```bash
cd PomodoroScreen/Debug
sqlite3 statistics-debug.db "
SELECT 
    datetime(timestamp, 'unixepoch', 'localtime') as time,
    event_type
FROM statistics_events
WHERE event_type = 'stay_up_late_activity'
ORDER BY timestamp DESC
LIMIT 20;
"
```

检查时间戳是否有睡眠期间的记录。

### 热力图验证

1. 在熬夜时段睡眠至少1小时
2. 唤醒后查看健康报告
3. 睡眠期间的半小时槽不应该显示黄色标记

## 🚀 下一步建议

### 可选增强

1. **睡眠时长统计**：
   ```swift
   private var sleepStartTime: Date?
   
   @objc private func systemWillSleep() {
       sleepStartTime = Date()
       // ...
   }
   
   @objc private func systemDidWake() {
       if let start = sleepStartTime {
           let duration = Date().timeIntervalSince(start)
           print("🛌 睡眠时长: \(duration / 3600) 小时")
       }
       // ...
   }
   ```

2. **睡眠质量报告**：
   - 记录每天的睡眠/唤醒次数
   - 统计平均睡眠时长
   - 在健康报告中显示睡眠趋势

3. **智能提醒**：
   - 如果连续多天睡眠不足，发送健康提醒
   - 结合熬夜时段，提供睡眠建议

### 测试覆盖

1. **边界情况测试**：
   - 23:59 睡眠，00:01 唤醒（跨天）
   - 长时间睡眠（8小时+）
   - 频繁短时间睡眠/唤醒

2. **性能测试**：
   - 通知响应延迟
   - 内存泄漏检测
   - 长时间运行稳定性

## 📝 总结

✅ **已完成**：
- 系统睡眠监听机制
- 睡眠期间停止记录熬夜活动
- 唤醒后自动恢复记录
- 详细的测试文档

✅ **已验证**：
- 编译通过
- 现有测试通过
- 代码符合项目规范

✅ **文档完善**：
- 代码注释清晰
- 手动测试用例完整
- 设计决策有记录

---

**实现日期**: 2026-01-03  
**遵循规范**: 
- ✅ 循序渐进的重构策略
- ✅ 控制变量法（单一功能变更）
- ✅ 添加注释说明设计决策
- ✅ 编译通过后再提交

