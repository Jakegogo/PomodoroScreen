# ä»£ç å˜æ›´æ¸…å• - é®ç½©å±‚å€’è®¡æ—¶æŒ‰é’®

## ğŸ“… å˜æ›´ä¿¡æ¯
- **æ—¥æœŸ**: 2026-01-09
- **åŠŸèƒ½**: é®ç½©å±‚å–æ¶ˆæŒ‰é’®æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œé¼ æ ‡æ‚¬åœåˆ‡æ¢ä¸º"å–æ¶ˆä¼‘æ¯"
- **å½±å“èŒƒå›´**: UI/Window, æµ‹è¯•

## ğŸ¯ éœ€æ±‚æè¿°

é®ç½©å±‚æ˜¾ç¤ºæ—¶ï¼Œå–æ¶ˆæŒ‰é’®çš„æ–‡å­—æ”¹ä¸ºå‰©ä½™ä¼‘æ¯æ—¶é•¿çš„å€’è®¡æ—¶ï¼Œéœ€è¦æ¯ç§’åˆ·æ–°ä¸€æ¬¡æ›´æ–°å€’è®¡æ—¶ã€‚å½“é¼ æ ‡hoveråˆ°æŒ‰é’®ä¸Šæ—¶ï¼Œåˆ‡æ¢æˆå–æ¶ˆä¼‘æ¯ã€‚ç‚¹å‡»ä¾ç„¶å¯ä»¥å–æ¶ˆã€‚

## ğŸ“ ä»£ç å˜æ›´è¯¦æƒ…

### 1. PomodoroScreen/UI/Window/OverlayWindow.swift

#### å˜æ›´ 1.1: æ·»åŠ æ–°å±æ€§
**ä½ç½®**: OverlayView ç±»å®šä¹‰å¼€å§‹éƒ¨åˆ†ï¼ˆçº¦ 702-712 è¡Œï¼‰

**ä¿®æ”¹å‰**:
```swift
class OverlayView: NSView {
    
    var onDismiss: (() -> Void)?
    private var cancelButton: NSButton!
    private var shutdownButton: NSButton!
    private var messageLabel: NSTextField!
    private var timer: PomodoroTimer?
    private var isPreviewMode: Bool = false
    private var shutdownConfirmationWindow: ShutdownConfirmationWindow?
```

**ä¿®æ”¹å**:
```swift
class OverlayView: NSView {
    
    var onDismiss: (() -> Void)?
    private var cancelButton: NSButton!
    private var shutdownButton: NSButton!
    private var messageLabel: NSTextField!
    private var timer: PomodoroTimer?
    private var isPreviewMode: Bool = false
    private var shutdownConfirmationWindow: ShutdownConfirmationWindow?
    private var countdownTimer: Timer?  // å€’è®¡æ—¶å®šæ—¶å™¨
    private var isHoveringCancelButton: Bool = false  // æ˜¯å¦é¼ æ ‡æ‚¬åœåœ¨å–æ¶ˆæŒ‰é’®ä¸Š
```

**è¯´æ˜**: æ·»åŠ ä¸¤ä¸ªæ–°å±æ€§æ¥æ”¯æŒå€’è®¡æ—¶åŠŸèƒ½å’Œé¼ æ ‡æ‚¬åœçŠ¶æ€è·Ÿè¸ªã€‚

---

#### å˜æ›´ 1.2: ä¿®æ”¹æŒ‰é’®é…ç½®
**ä½ç½®**: cancelButtonConfig è®¡ç®—å±æ€§ï¼ˆçº¦ 719-726 è¡Œï¼‰

**ä¿®æ”¹å‰**:
```swift
private var cancelButtonConfig: OverlayButtonConfig {
    return OverlayButtonConfig(
        title: "å–æ¶ˆä¼‘æ¯",
        width: 90,
        height: 32,
        action: #selector(cancelButtonClicked)
    )
}
```

**ä¿®æ”¹å**:
```swift
private var cancelButtonConfig: OverlayButtonConfig {
    // é»˜è®¤æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œè€Œä¸æ˜¯"å–æ¶ˆä¼‘æ¯"
    let title = getCountdownString()
    return OverlayButtonConfig(
        title: title,
        width: 90,
        height: 32,
        action: #selector(cancelButtonClicked)
    )
}

// è·å–å€’è®¡æ—¶å­—ç¬¦ä¸²
private func getCountdownString() -> String {
    guard let timer = timer else { return "00:00" }
    let remainingTime = timer.getRemainingTime()
    let minutes = Int(remainingTime) / 60
    let seconds = Int(remainingTime) % 60
    return String(format: "%02d:%02d", minutes, seconds)
}
```

**è¯´æ˜**: æŒ‰é’®åˆå§‹åŒ–æ—¶æ˜¾ç¤ºå€’è®¡æ—¶è€Œä¸æ˜¯å›ºå®šæ–‡å­—ï¼Œå¹¶æ·»åŠ æ ¼å¼åŒ–å€’è®¡æ—¶çš„è¾…åŠ©æ–¹æ³•ã€‚

---

#### å˜æ›´ 1.3: æ·»åŠ å€’è®¡æ—¶å®šæ—¶å™¨é€»è¾‘
**ä½ç½®**: setupView() æ–¹æ³•æœ«å°¾ï¼ˆçº¦ 812 è¡Œä¹‹åï¼‰

**æ–°å¢ä»£ç **:
```swift
// åœ¨ setupView() çš„æŒ‰é’®è®¾ç½®åæ·»åŠ 
if shouldShowButton {
    setupButton(with: cancelButtonConfig, as: &cancelButton, buttonType: "cancel")
    // å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°æŒ‰é’®æ–‡å­—
    startCountdownTimer()
}

// MARK: - Countdown Timer

/// å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°æŒ‰é’®æ–‡å­—
private func startCountdownTimer() {
    // ç¡®ä¿ä¹‹å‰çš„å®šæ—¶å™¨å·²åœæ­¢
    stopCountdownTimer()
    
    // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ¯ç§’è§¦å‘ä¸€æ¬¡
    countdownTimer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { [weak self] _ in
        self?.updateCancelButtonTitle()
    }
}

/// åœæ­¢å€’è®¡æ—¶å®šæ—¶å™¨
private func stopCountdownTimer() {
    countdownTimer?.invalidate()
    countdownTimer = nil
}

/// æ›´æ–°å–æ¶ˆæŒ‰é’®çš„æ ‡é¢˜
private func updateCancelButtonTitle() {
    guard let cancelButton = cancelButton else { return }
    
    // å¦‚æœé¼ æ ‡æ‚¬åœï¼Œæ˜¾ç¤º"å–æ¶ˆä¼‘æ¯"ï¼Œå¦åˆ™æ˜¾ç¤ºå€’è®¡æ—¶
    if isHoveringCancelButton {
        cancelButton.title = "å–æ¶ˆä¼‘æ¯"
    } else {
        cancelButton.title = getCountdownString()
    }
}

/// æ¸…ç†èµ„æº
deinit {
    stopCountdownTimer()
}
```

**è¯´æ˜**: 
- åœ¨æŒ‰é’®è®¾ç½®å®Œæˆåå¯åŠ¨å®šæ—¶å™¨
- æ¯ç§’æ›´æ–°æŒ‰é’®æ ‡é¢˜
- æ ¹æ®æ‚¬åœçŠ¶æ€å†³å®šæ˜¾ç¤ºå€’è®¡æ—¶è¿˜æ˜¯"å–æ¶ˆä¼‘æ¯"
- deinit ä¸­æ¸…ç†å®šæ—¶å™¨é¿å…å†…å­˜æ³„æ¼

---

#### å˜æ›´ 1.4: ä¿®æ”¹é¼ æ ‡æ‚¬åœå¤„ç†
**ä½ç½®**: handleButtonHover() æ–¹æ³•ï¼ˆçº¦ 1033-1040 è¡Œï¼‰

**ä¿®æ”¹å‰**:
```swift
case "cancel":
    guard let cancelButton = cancelButton else { return }
    let targetAlpha: CGFloat = isEntering ? 1.0 : 0.4
    animateButtonAlpha(cancelButton, to: targetAlpha, duration: 0.2)
```

**ä¿®æ”¹å**:
```swift
case "cancel":
    guard let cancelButton = cancelButton else { return }
    
    // æ›´æ–°æ‚¬åœçŠ¶æ€
    isHoveringCancelButton = isEntering
    
    // ç«‹å³æ›´æ–°æŒ‰é’®æ–‡å­—
    updateCancelButtonTitle()
    
    // é€æ˜åº¦åŠ¨ç”»
    let targetAlpha: CGFloat = isEntering ? 1.0 : 0.4
    animateButtonAlpha(cancelButton, to: targetAlpha, duration: 0.2)
```

**è¯´æ˜**: åœ¨é¼ æ ‡è¿›å…¥/ç¦»å¼€æ—¶æ›´æ–°æ‚¬åœçŠ¶æ€æ ‡è®°ï¼Œå¹¶ç«‹å³åˆ·æ–°æŒ‰é’®æ–‡å­—ã€‚

---

#### å˜æ›´ 1.5: ä¿®æ”¹æ–¹æ³•è®¿é—®çº§åˆ«
**ä½ç½®**: æŒ‰é’®ç‚¹å‡»æ–¹æ³•ï¼ˆçº¦ 1077-1090 è¡Œï¼‰

**ä¿®æ”¹å‰**:
```swift
@objc private func cancelButtonClicked() {
@objc private func previewButtonClicked() {
@objc private func shutdownButtonClicked() {
```

**ä¿®æ”¹å**:
```swift
@objc func cancelButtonClicked() {
@objc func previewButtonClicked() {
@objc func shutdownButtonClicked() {
```

**è¯´æ˜**: å°†æ–¹æ³•ä» private æ”¹ä¸º internalï¼Œä»¥ä¾¿å•å…ƒæµ‹è¯•å¯ä»¥è®¿é—®ã€‚è¿™æ˜¯ä¸ºäº†æ”¯æŒæµ‹è¯•éªŒè¯æŒ‰é’® action çš„æ­£ç¡®æ€§ã€‚

---

### 2. PomodoroScreenTests/CountdownButtonTests.swift (æ–°æ–‡ä»¶)

**æ–‡ä»¶è·¯å¾„**: `/Users/jake/Documents/Projects/PomodoroScreen/PomodoroScreenTests/CountdownButtonTests.swift`

**è¯´æ˜**: æ–°å¢å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼ŒåŒ…å« 5 ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

**æµ‹è¯•ç”¨ä¾‹**:
1. `testCancelButton_InitialTitle_ShowsCountdown()` - éªŒè¯æŒ‰é’®åˆå§‹æ˜¾ç¤ºå€’è®¡æ—¶
2. `testCancelButton_CountdownUpdates_EverySecond()` - éªŒè¯å€’è®¡æ—¶æ¯ç§’æ›´æ–°
3. `testCancelButton_OnHover_ShowsCancelText()` - éªŒè¯é¼ æ ‡æ‚¬åœæ˜¾ç¤º"å–æ¶ˆä¼‘æ¯"
4. `testCancelButton_OnHoverExit_RestoresCountdown()` - éªŒè¯é¼ æ ‡ç§»å‡ºæ¢å¤å€’è®¡æ—¶
5. `testCancelButton_OnHoverClick_HasCorrectAction()` - éªŒè¯æŒ‰é’® action æ­£ç¡®è®¾ç½®

**è¾…åŠ©å·¥å…·**:
- NSEvent æ‰©å±•ï¼Œç”¨äºæ¨¡æ‹Ÿé¼ æ ‡è¿›å…¥/ç¦»å¼€äº‹ä»¶

---

### 3. docs/é®ç½©å±‚å€’è®¡æ—¶æŒ‰é’®åŠŸèƒ½è¯´æ˜.md (æ–°æ–‡ä»¶)

**æ–‡ä»¶è·¯å¾„**: `/Users/jake/Documents/Projects/PomodoroScreen/docs/é®ç½©å±‚å€’è®¡æ—¶æŒ‰é’®åŠŸèƒ½è¯´æ˜.md`

**è¯´æ˜**: è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- åŠŸèƒ½æ¦‚è¿°
- è®¾è®¡ç›®æ ‡
- æŠ€æœ¯å®ç°
- æµ‹è¯•è¦†ç›–
- UI æ•ˆæœ
- ä½¿ç”¨åœºæ™¯
- æ³¨æ„äº‹é¡¹
- åç»­ä¼˜åŒ–æ–¹å‘

---

## âœ… ç¼–è¯‘éªŒè¯

### ç¼–è¯‘å‘½ä»¤
```bash
cd /Users/jake/Documents/Projects/PomodoroScreen
xcodebuild -project PomodoroScreen.xcodeproj -scheme PomodoroScreen -configuration Debug build
```

### ç¼–è¯‘ç»“æœ
```
** BUILD SUCCEEDED **
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•å‘½ä»¤
```bash
cd /Users/jake/Documents/Projects/PomodoroScreen
xcodebuild test -scheme PomodoroScreen -destination 'platform=macOS' \
  -only-testing:PomodoroScreenTests/CountdownButtonTests
```

### æµ‹è¯•ç»“æœ
```
âœ… testCancelButton_CountdownUpdates_EverySecond() passed (3.034 seconds)
âœ… testCancelButton_InitialTitle_ShowsCountdown() passed (0.510 seconds)
âœ… testCancelButton_OnHover_ShowsCancelText() passed (4.814 seconds)
âœ… testCancelButton_OnHoverClick_HasCorrectAction() passed (4.514 seconds)
âœ… testCancelButton_OnHoverExit_RestoresCountdown() passed (5.198 seconds)

å…¨éƒ¨æµ‹è¯•é€šè¿‡ (5/5)
```

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•

- [x] æŒ‰é’®åˆå§‹æ˜¾ç¤ºå€’è®¡æ—¶æ ¼å¼ (MM:SS)
- [x] å€’è®¡æ—¶æ¯ç§’è‡ªåŠ¨æ›´æ–°
- [x] é¼ æ ‡æ‚¬åœæ—¶åˆ‡æ¢ä¸º"å–æ¶ˆä¼‘æ¯"æ–‡å­—
- [x] é¼ æ ‡ç§»å‡ºåæ¢å¤å€’è®¡æ—¶æ˜¾ç¤º
- [x] ç‚¹å‡»æŒ‰é’®ä»ç„¶å¯ä»¥å–æ¶ˆä¼‘æ¯
- [x] å®šæ—¶å™¨åœ¨è§†å›¾é”€æ¯æ—¶æ­£ç¡®æ¸…ç†
- [x] ä¸å½±å“é¢„è§ˆæ¨¡å¼æŒ‰é’®
- [x] ä¸å½±å“å¼ºåˆ¶ç¡çœ æ¨¡å¼æŒ‰é’®
- [x] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [x] ç¼–è¯‘æ— é”™è¯¯æ— è­¦å‘Šï¼ˆå¿½ç•¥å·²æœ‰çš„é‡å¤æ–‡ä»¶è­¦å‘Šï¼‰

---

## ğŸ“Š å½±å“åˆ†æ

### åŠŸèƒ½å½±å“
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… **ç”¨æˆ·ä½“éªŒ**: æå‡äº†æ—¶é—´æ„ŸçŸ¥èƒ½åŠ›
- âœ… **æ€§èƒ½å½±å“**: å¾®å°ï¼ˆæ¯ç§’ä¸€æ¬¡æ–‡å­—æ›´æ–°ï¼‰

### ä»£ç å½±å“
- **æ–°å¢ä»£ç è¡Œæ•°**: çº¦ 150 è¡Œï¼ˆåŒ…æ‹¬æµ‹è¯•ï¼‰
- **ä¿®æ”¹ä»£ç è¡Œæ•°**: çº¦ 30 è¡Œ
- **æ–°å¢æ–‡ä»¶**: 2 ä¸ªï¼ˆæµ‹è¯•æ–‡ä»¶ + æ–‡æ¡£ï¼‰
- **ä¿®æ”¹æ–‡ä»¶**: 1 ä¸ªï¼ˆOverlayWindow.swiftï¼‰

### æµ‹è¯•è¦†ç›–
- **æ–°å¢æµ‹è¯•ç”¨ä¾‹**: 5 ä¸ª
- **æµ‹è¯•è¦†ç›–ç‡**: æ ¸å¿ƒåŠŸèƒ½ 100%
- **æµ‹è¯•é€šè¿‡ç‡**: 100% (5/5)

---

## ğŸ”„ å›å½’æµ‹è¯•å»ºè®®

å»ºè®®è¿è¡Œä»¥ä¸‹æµ‹è¯•ç¡®ä¿æ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½ï¼š

```bash
# è¿è¡Œæ‰€æœ‰ Overlay ç›¸å…³æµ‹è¯•
xcodebuild test -scheme PomodoroScreen -destination 'platform=macOS' \
  -only-testing:PomodoroScreenTests/OverlayVisibilityTests

# è¿è¡ŒæŒ‰é’®äº¤äº’æµ‹è¯•
xcodebuild test -scheme PomodoroScreen -destination 'platform=macOS' \
  -only-testing:PomodoroScreenTests/BreakMessageTests

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
xcodebuild test -scheme PomodoroScreen -destination 'platform=macOS'
```

---

## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] æ‰‹åŠ¨æµ‹è¯•ï¼šå®é™…è¿è¡Œåº”ç”¨ï¼ŒéªŒè¯å€’è®¡æ—¶æ˜¾ç¤ºå’Œé¼ æ ‡æ‚¬åœäº¤äº’
- [ ] è§†è§‰æµ‹è¯•ï¼šç¡®è®¤å€’è®¡æ—¶æ•°å­—ä¸ä¼šå› ä¸ºå®½åº¦å˜åŒ–è€ŒæŠ–åŠ¨ï¼ˆè€ƒè™‘ä½¿ç”¨ç­‰å®½å­—ä½“ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡ŒéªŒè¯å®šæ—¶å™¨æ²¡æœ‰å†…å­˜æ³„æ¼
- [ ] å¯è®¿é—®æ€§æµ‹è¯•ï¼šç¡®ä¿å±å¹•é˜…è¯»å™¨èƒ½æ­£ç¡®è¯»å–æŒ‰é’®çŠ¶æ€

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å˜æ›´æˆåŠŸå®ç°äº†é®ç½©å±‚å–æ¶ˆæŒ‰é’®çš„å€’è®¡æ—¶æ˜¾ç¤ºåŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒäº†åŸæœ‰çš„å–æ¶ˆä¼‘æ¯èƒ½åŠ›ã€‚é€šè¿‡é¼ æ ‡æ‚¬åœåˆ‡æ¢æ–‡å­—çš„äº¤äº’è®¾è®¡ï¼Œåœ¨æä¾›æ›´å¤šä¿¡æ¯çš„åŒæ—¶ä¸å½±å“ç”¨æˆ·çš„æ“ä½œæµç¨‹ã€‚

**å…³é”®æŠ€æœ¯ç‚¹**:
1. ä½¿ç”¨ Timer å®ç°æ¯ç§’æ›´æ–°
2. ä½¿ç”¨çŠ¶æ€æ ‡è®°æ§åˆ¶æ–‡å­—åˆ‡æ¢
3. æ­£ç¡®ç®¡ç†å®šæ—¶å™¨ç”Ÿå‘½å‘¨æœŸé¿å…å†…å­˜æ³„æ¼
4. å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

**ç”¨æˆ·ä»·å€¼**:
1. å®æ—¶äº†è§£å‰©ä½™ä¼‘æ¯æ—¶é—´
2. æ›´å¥½çš„æ—¶é—´æ„ŸçŸ¥å’Œè®¡åˆ’èƒ½åŠ›
3. ä¿æŒç®€æ´çš„ç•Œé¢è®¾è®¡
4. æµç•…çš„äº¤äº’ä½“éªŒ

---

**å˜æ›´äºº**: Cursor AI  
**å®¡æ ¸äºº**: å¾…å®¡æ ¸  
**æ‰¹å‡†äºº**: å¾…æ‰¹å‡†  
**çŠ¶æ€**: âœ… å®Œæˆ
