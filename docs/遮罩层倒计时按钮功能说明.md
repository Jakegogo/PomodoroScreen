# 遮罩层倒计时按钮功能说明

## 📋 功能概述

在遮罩层（休息提醒）显示时，取消按钮的行为进行了增强：
- **默认状态**：显示剩余休息时长的倒计时（格式：MM:SS）
- **鼠标悬停**：切换为"取消休息"文字
- **点击功能**：保持原有的取消休息功能

## 🎯 设计目标

### 1. 用户体验优化
- 用户可以实时看到剩余休息时间，无需估算
- 鼠标悬停时明确提示可以取消，降低操作学习成本
- 保持简洁的界面设计，不增加额外的 UI 元素

### 2. 交互逻辑
```
按钮初始化
    ↓
显示倒计时 (00:05)
    ↓
每秒自动更新 (00:04, 00:03, ...)
    ↓
用户鼠标移入按钮
    ↓
显示文字切换为"取消休息"
    ↓
用户点击 → 取消休息，关闭遮罩层
    或
用户鼠标移出 → 恢复显示倒计时
```

## 🔧 技术实现

### 核心组件

#### 1. OverlayView 类扩展

**新增属性：**
```swift
private var countdownTimer: Timer?           // 倒计时定时器
private var isHoveringCancelButton: Bool     // 鼠标悬停状态标记
```

**新增方法：**
- `getCountdownString()` - 获取格式化的倒计时字符串
- `startCountdownTimer()` - 启动每秒更新的定时器
- `stopCountdownTimer()` - 停止定时器
- `updateCancelButtonTitle()` - 更新按钮标题

#### 2. 倒计时更新机制

```swift
// 启动定时器
countdownTimer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { [weak self] _ in
    self?.updateCancelButtonTitle()
}

// 更新按钮文字
private func updateCancelButtonTitle() {
    guard let cancelButton = cancelButton else { return }
    
    if isHoveringCancelButton {
        cancelButton.title = "取消休息"
    } else {
        cancelButton.title = getCountdownString()  // 格式：MM:SS
    }
}
```

#### 3. 鼠标悬停处理

修改 `handleButtonHover` 方法：
```swift
case "cancel":
    // 更新悬停状态
    isHoveringCancelButton = isEntering
    
    // 立即更新按钮文字
    updateCancelButtonTitle()
    
    // 透明度动画
    let targetAlpha: CGFloat = isEntering ? 1.0 : 0.4
    animateButtonAlpha(cancelButton, to: targetAlpha, duration: 0.2)
```

### 数据流

```
PomodoroTimer
    ↓ getRemainingTime()
OverlayView
    ↓ formatTime()
"05:23" 字符串
    ↓ 
NSButton.title
    ↓
RubikDoodleShadow-Regular 字体渲染
```

### 字体加载机制

```swift
// 在 cancelButtonConfig 中加载自定义字体
let customFont = loadCustomFont(name: "RubikDoodleShadow-Regular", size: 14) 
    ?? NSFont.systemFont(ofSize: 14, weight: .regular)

// 字体加载流程（参考 HealthRingsView 实现）
1. 尝试直接通过字体名称加载（NSFont(name:size:)）
   ├─ 成功 → 返回字体
   └─ 失败 ↓
2. 从 Bundle 查找字体文件 (RubikDoodleShadow-Regular.ttf)
3. 读取字体数据 (NSData)
4. 创建 CGDataProvider 和 CGFont
5. 获取 PostScript 名称
6. 注册字体到系统 (CTFontManagerRegisterGraphicsFont)
7. 使用 PostScript 名称创建 NSFont
```

**回退机制**: 如果字体加载失败，自动使用系统默认字体，确保应用正常运行。

**实现特点**:
- 参考 `HealthRingsView.swift` 的 `preloadCustomFont` 方法
- 无需 Info.plist 配置
- 支持字体复用（如果已注册，直接加载）
- 完善的错误处理和日志输出

## 📊 测试覆盖

### 单元测试文件
`PomodoroScreenTests/CountdownButtonTests.swift`

### 测试用例

| 测试名称 | 测试内容 | 结果 |
|---------|---------|------|
| `testCancelButton_InitialTitle_ShowsCountdown` | 按钮初始显示倒计时格式 | ✅ |
| `testCancelButton_CountdownUpdates_EverySecond` | 倒计时每秒更新 | ✅ |
| `testCancelButton_OnHover_ShowsCancelText` | 鼠标悬停显示"取消休息" | ✅ |
| `testCancelButton_OnHoverExit_RestoresCountdown` | 鼠标移出恢复倒计时 | ✅ |
| `testCancelButton_OnHoverClick_HasCorrectAction` | 按钮 action 正确设置 | ✅ |

### 测试执行命令

```bash
cd /Users/jake/Documents/Projects/PomodoroScreen
xcodebuild test -scheme PomodoroScreen -destination 'platform=macOS' \
  -only-testing:PomodoroScreenTests/CountdownButtonTests
```

## 🎨 UI 效果

### 默认状态
```
┌─────────────────────────────┐
│                             │
│      番茄钟时间到！          │
│                             │
│      休息时间，5分钟        │
│      后自动恢复              │
│                             │
│                             │
│        ┌─────────┐          │
│        │  04:23  │  ← 倒计时（RubikDoodleShadow 字体）  │
│        └─────────┘          │
│         (透明度 0.4)        │
└─────────────────────────────┘
```

### 鼠标悬停状态
```
┌─────────────────────────────┐
│                             │
│      番茄钟时间到！          │
│                             │
│      休息时间，5分钟        │
│      后自动恢复              │
│                             │
│                             │
│        ┌─────────┐          │
│        │取消休息 │  ← 提示文字（RubikDoodleShadow 字体）  │
│        └─────────┘          │
│         (透明度 1.0)        │
└─────────────────────────────┘
```

### 字体特性
- **字体名称**: RubikDoodleShadow-Regular
- **字体风格**: 手写涂鸦风格，带有阴影效果
- **字体大小**: 14pt
- **特点**: 独特的艺术感，适合休闲场景，清晰易读

## 🔄 生命周期管理

### 初始化流程
1. OverlayView 初始化
2. 设置取消按钮（如果允许）
3. 启动倒计时定时器（每秒触发）
4. 按钮淡入动画（3秒后）
5. 启用鼠标悬停追踪

### 清理流程
```swift
deinit {
    stopCountdownTimer()  // 停止定时器，防止内存泄漏
}
```

## 📝 代码变更清单

### 修改的文件

1. **PomodoroScreen/UI/Window/OverlayWindow.swift**
   - 添加倒计时定时器和悬停状态属性
   - 修改 `cancelButtonConfig` 返回倒计时文字
   - 添加 `getCountdownString()` 方法
   - 添加 `startCountdownTimer()`、`stopCountdownTimer()` 方法
   - 添加 `updateCancelButtonTitle()` 方法
   - 修改 `handleButtonHover` 处理文字切换
   - 修改 `cancelButtonClicked` 等方法访问级别为 internal
   - 添加 `deinit` 清理资源

2. **PomodoroScreenTests/CountdownButtonTests.swift** (新增)
   - 5 个单元测试用例
   - NSEvent 扩展用于模拟鼠标事件

## 🚀 使用场景

### 场景 1：查看剩余休息时间
**用户需求**：想知道还要休息多久

**操作流程**：
1. 遮罩层出现
2. 直接看按钮上的倒计时：04:23
3. 知道还有 4 分 23 秒

### 场景 2：临时取消休息
**用户需求**：有紧急任务需要立即处理

**操作流程**：
1. 看到倒计时显示
2. 鼠标移到按钮上
3. 按钮变为"取消休息"
4. 点击取消
5. 遮罩层关闭，继续工作

### 场景 3：改变主意继续休息
**用户需求**：准备取消但又决定继续休息

**操作流程**：
1. 鼠标移到按钮上
2. 按钮显示"取消休息"
3. 决定不取消
4. 鼠标移出按钮
5. 按钮恢复显示倒计时
6. 继续休息

## 🔍 注意事项

### 1. 性能考虑
- 定时器每秒触发一次，开销很小
- 使用 weak self 避免循环引用
- 在 deinit 中确保定时器停止

### 2. 兼容性
- 与现有的按钮淡入淡出动画兼容
- 与鼠标追踪区域机制兼容
- 与 ESC 键取消功能兼容

### 3. 边界情况
- 时间为 0 时显示 00:00
- 预览模式下使用"关闭预览"按钮，不受影响
- 强制睡眠模式下使用"关机休息"按钮，不受影响

## 📈 后续优化方向

### 1. 可配置性
- 允许用户选择是否显示倒计时（设置项）
- 允许自定义倒计时格式（如：4分23秒）

### 2. 视觉增强
- 倒计时字体使用等宽字体，避免数字跳动
- 时间快结束时（如最后 30 秒）改变颜色提示

### 3. 交互优化
- 支持点击倒计时数字直接调整休息时间
- 支持拖动进度条快进或延长休息

## 🎉 总结

此功能通过在取消按钮上显示实时倒计时，提升了用户对休息剩余时间的感知，同时保持了原有的取消功能。通过鼠标悬停切换文字的交互方式，既提供了信息，又不影响操作流程，是一个轻量级但体验友好的改进。

---

**创建时间**: 2026-01-09  
**作者**: Cursor AI  
**版本**: 1.0.0
