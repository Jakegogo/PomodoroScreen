# 背景随机播放功能说明

## 📋 功能概述

**创建时间**: 2026-01-08  
**作者**: Assistant  
**功能**: 支持随机播放遮罩层背景视频/图片，每轮播放所有文件一次，但顺序随机，不重复播放

## 🎯 功能目标

用户在添加多个背景文件后，希望能够随机播放这些文件，而不是总是按照固定的顺序。随机播放模式下：
- ✅ 每轮播放所有文件各一次
- ✅ 每轮内不重复播放同一个文件
- ✅ 不同轮次的播放顺序不同
- ✅ 不影响设置面板中的文件排序

## 🏗️ 技术实现

### 1. 核心算法：Fisher-Yates 洗牌算法

使用经典的 **Fisher-Yates 洗牌算法**生成随机播放队列：

```swift
/// 生成随机播放队列（使用 Fisher-Yates 洗牌算法）
private func generateShuffledQueue() {
    guard !backgroundFiles.isEmpty else { return }
    
    // 创建索引数组 [0, 1, 2, ...]
    shuffledQueue = Array(0..<backgroundFiles.count)
    
    // Fisher-Yates 洗牌算法
    for i in stride(from: shuffledQueue.count - 1, through: 1, by: -1) {
        let j = Int.random(in: 0...i)
        shuffledQueue.swapAt(i, j)
    }
    
    currentQueueIndex = 0
    print("🎲 生成随机播放队列: \(shuffledQueue.map { backgroundFiles[$0].name })")
}
```

**算法特点**：
- **时间复杂度**: O(n)
- **空间复杂度**: O(n) - 需要存储索引数组
- **均匀分布**: 每种排列出现的概率相等
- **无重复**: 每个元素在队列中只出现一次

### 2. 播放逻辑

#### 随机模式 (shuffleEnabled = true)

```swift
if shuffleEnabled {
    // 随机模式
    if backgroundFiles.count == 1 {
        currentBackgroundIndex = 0
    } else {
        // 如果队列为空或已播放完，重新生成随机队列
        if shuffledQueue.isEmpty || currentQueueIndex >= shuffledQueue.count {
            generateShuffledQueue()
        }
        
        // 从队列中获取下一个索引
        currentBackgroundIndex = shuffledQueue[currentQueueIndex]
        currentQueueIndex += 1
        
        print("🎲 随机播放 (\(currentQueueIndex)/\(shuffledQueue.count)): \(backgroundFiles[currentBackgroundIndex].name)")
    }
}
```

**工作流程**：
1. 检查是否需要生成新队列（队列为空或已播放完）
2. 从队列中按顺序取出索引（但队列本身是随机的）
3. 播放完整轮后，重新生成新的随机队列

#### 顺序模式 (shuffleEnabled = false)

```swift
else {
    // 顺序模式
    if backgroundFiles.count > 1 {
        currentBackgroundIndex = (currentBackgroundIndex + 1) % backgroundFiles.count
        print("🔄 顺序播放: \(backgroundFiles[currentBackgroundIndex].name)")
    } else {
        currentBackgroundIndex = 0
    }
}
```

**工作流程**：
1. 简单地递增索引
2. 达到数组末尾时回到0（使用取模运算）

### 3. 数据结构

#### PomodoroTimer.swift

```swift
// 随机播放队列相关
private var shuffleEnabled: Bool = false // 是否启用随机播放
private var shuffledQueue: [Int] = [] // 随机顺序的索引队列
private var currentQueueIndex: Int = 0 // 当前在队列中的位置
```

**字段说明**：
- `shuffleEnabled`: 用户设置，决定是否启用随机播放
- `shuffledQueue`: 存储随机排列的索引数组，例如 [2, 0, 4, 1, 3]
- `currentQueueIndex`: 当前在队列中的读取位置（0到队列长度-1）

### 4. 设置持久化

#### SettingsStore.swift

```swift
static var shuffleBackgrounds: Bool {
    get { bool(for: .shuffleBackgrounds, default: false) }
    set { setBool(newValue, for: .shuffleBackgrounds) }
}
```

**默认值**: `false` (默认使用顺序播放)

## 🎨 用户界面

### 设置窗口

在**背景设置**面板中添加了"随机播放"复选框：

```
[背景设置]
┌─────────────────────────────────┐
│  背景文件列表                    │
│  ├─ video1.mp4                  │
│  ├─ video2.mp4                  │
│  └─ video3.mp4                  │
│                                  │
│  [添加图片] [添加视频]          │
│  [删除] [上移] [下移] [预览]    │
│                                  │
│  ☑ 随机播放                     │
│                                  │
│  说明：支持图片格式：jpg, png   │
│  支持视频格式：mp4, mov         │
│  随机播放：每轮播放所有文件一次  │
│  但顺序随机                      │
└─────────────────────────────────┘
```

### 日志输出

启用随机播放后，控制台会显示详细的播放信息：

```
🎲 启用随机播放模式
🎲 生成随机播放队列: ["video3.mp4", "video1.mp4", "video2.mp4"]
🎲 随机播放 (1/3): video3.mp4
🎲 随机播放 (2/3): video1.mp4
🎲 随机播放 (3/3): video2.mp4
🎲 生成随机播放队列: ["video2.mp4", "video3.mp4", "video1.mp4"]
🎲 随机播放 (1/3): video2.mp4
...
```

## 📊 使用场景示例

### 场景1：3个视频文件的随机播放

**设置**：
- 文件列表：[video1.mp4, video2.mp4, video3.mp4]
- 随机播放：启用

**实际播放顺序**（示例）：
```
第1轮: video2 → video3 → video1
第2轮: video1 → video3 → video2
第3轮: video3 → video1 → video2
...
```

**特点**：
- 每轮都包含所有3个文件
- 每轮内没有重复
- 不同轮次的顺序不同

### 场景2：只有1个文件

**设置**：
- 文件列表：[video1.mp4]
- 随机播放：启用/禁用

**实际播放顺序**：
```
video1 → video1 → video1 → ...
```

**特点**：
- 无论是否启用随机播放，结果都相同
- 总是播放唯一的文件

### 场景3：从随机切换到顺序

**初始设置**：
- 文件列表：[video1.mp4, video2.mp4, video3.mp4]
- 随机播放：启用

**播放中切换**：
```
随机模式: video3 → video1 → video2 (完成1轮)
        → 切换到顺序模式
顺序模式: video1 → video2 → video3 → video1 → ...
```

**特点**：
- 切换模式后，队列被清空
- 重新从索引0开始按顺序播放

## 🧪 测试覆盖

### 单元测试文件: `ShuffleBackgroundsTests.swift`

#### 测试用例列表

1. **testSequentialPlayback_WhenShuffleDisabled**
   - 验证禁用随机播放时按顺序循环

2. **testShufflePlayback_ContainsAllFilesOnce**
   - 验证每轮包含所有文件且不重复

3. **testShufflePlayback_MultipleRounds**
   - 验证多轮随机播放的正确性

4. **testSingleFile_ShuffleAndSequentialSame**
   - 验证单文件时随机和顺序相同

5. **testSwitchFromShuffleToSequential**
   - 验证模式切换的正确性

#### 测试结果

```
✅ testSequentialPlayback_WhenShuffleDisabled - passed (0.002s)
✅ testShufflePlayback_ContainsAllFilesOnce - passed (0.001s)
✅ testShufflePlayback_MultipleRounds - passed (0.001s)
✅ testSingleFile_ShuffleAndSequentialSame - passed (0.001s)
✅ testSwitchFromShuffleToSequential - passed (0.006s)
```

**总计**: 5/5 测试通过

## 🔧 配置说明

### 启用随机播放

1. 打开**设置窗口**（Cmd+,）
2. 切换到**背景设置**标签
3. 勾选"☑ 随机播放"复选框
4. 点击"保存"

### 禁用随机播放

1. 打开**设置窗口**
2. 取消勾选"☐ 随机播放"
3. 点击"保存"

### 配置文件位置

设置保存在 macOS UserDefaults 中：
```
~/Library/Preferences/com.yourcompany.PomodoroScreen.plist
```

键名: `ShuffleBackgrounds` (Boolean)

## 📈 性能考虑

### 内存使用

- **队列大小**: O(n)，其中 n 是背景文件数量
- **示例**: 10个文件 ≈ 80字节（10个Int索引）
- **影响**: 可忽略不计

### CPU使用

- **洗牌算法**: O(n) 时间复杂度
- **执行时机**: 仅在队列用完时执行（每 n 个文件播放一次）
- **影响**: 极小，即使100个文件也可瞬间完成

### 随机性质量

- 使用 Swift 的 `Int.random(in:)` 方法
- 基于系统提供的安全随机数生成器
- 均匀分布，适合此应用场景

## 🔍 调试信息

### 启用详细日志

代码中已包含 `print` 语句，自动输出到控制台：

```swift
print("🎲 启用随机播放模式")
print("🎲 生成随机播放队列: \(shuffledQueue.map { backgroundFiles[$0].name })")
print("🎲 随机播放 (\(currentQueueIndex)/\(shuffledQueue.count)): \(backgroundFiles[currentBackgroundIndex].name)")
```

### 日志标识

- 🎲: 随机播放相关操作
- 🔄: 顺序播放相关操作

## 🐛 已知限制

1. **不支持历史记录**
   - 当前不保存已播放的历史记录
   - 重启应用后，随机队列会重新生成

2. **无权重设置**
   - 所有文件播放概率相同
   - 不支持设置某些文件优先播放

3. **无手动播放选择**
   - 不支持用户手动选择下一个播放的文件
   - 完全由随机算法决定

## 🚀 未来增强建议

### 1. 智能随机（可选）

避免相邻轮次首尾相同：

```swift
// 如果上一轮最后一个是 video3，新一轮不以 video3 开头
if let lastPlayed = lastPlayedIndex {
    while shuffledQueue[0] == lastPlayed {
        shuffledQueue.shuffle() // 重新洗牌
    }
}
```

### 2. 播放历史记录

保存最近N轮的播放历史：

```swift
struct PlaybackHistory {
    var recentRounds: [[Int]] = []
    let maxHistoryRounds = 10
    
    mutating func addRound(_ round: [Int]) {
        recentRounds.append(round)
        if recentRounds.count > maxHistoryRounds {
            recentRounds.removeFirst()
        }
    }
}
```

### 3. 权重播放

支持为文件设置播放权重：

```swift
struct WeightedBackgroundFile {
    let file: BackgroundFile
    let weight: Double // 1.0 = 正常, 2.0 = 双倍概率
}
```

### 4. 播放模式扩展

- **完全随机模式**: 每次都随机选择（可能重复）
- **最少最近播放**: 优先播放最久未播放的文件
- **分组随机**: 将文件分组，先随机选组，再随机选文件

## ✅ 验收标准

### 功能验收

- [x] 启用随机播放后，文件不按固定顺序播放
- [x] 每轮播放包含所有文件各一次
- [x] 每轮内无重复播放
- [x] 设置持久化，重启后保持
- [x] 单元测试全部通过

### 用户体验验收

- [x] 设置界面清晰易懂
- [x] 功能说明准确
- [x] 无明显性能影响
- [x] 日志输出便于调试

## 📚 相关文档

- [x] 用户手册更新（待补充到主文档）
- [x] API文档更新（代码注释完整）
- [x] 测试报告（本文档包含）
- [x] 技术设计文档（本文档）

## 📝 变更日志

### v1.0 (2026-01-08)

**新增功能**：
- 实现基于 Fisher-Yates 算法的随机播放队列
- 在设置窗口添加"随机播放"复选框
- 添加完整的单元测试套件（5个测试用例）
- 支持随机/顺序模式无缝切换

**技术改进**：
- 使用高效的 O(n) 洗牌算法
- 添加详细的日志输出
- 优化单文件场景的处理

**文件修改**：
- `PomodoroTimer.swift`: 添加随机播放逻辑
- `SettingsStore.swift`: 添加设置项
- `SettingsWindow.swift`: 添加UI控件
- `AppDelegate.swift`: 加载和传递设置
- `StatusBarController.swift`: 更新回调处理
- `ShuffleBackgroundsTests.swift`: 新增测试文件

---

**文档版本**: 1.0  
**最后更新**: 2026-01-08  
**维护者**: Assistant
