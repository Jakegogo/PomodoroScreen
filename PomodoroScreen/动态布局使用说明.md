# PomodoroScreen 动态布局系统

## 概述

PomodoroScreen 现在支持动态布局系统，可以轻松调整弹窗窗口的大小，所有UI元素会自动重新排列以适应新的窗口尺寸。

## 主要特性

### 1. 动态计算布局
- 所有UI元素位置和大小都基于窗口尺寸动态计算
- 支持不同宽度的窗口（推荐范围：280-400px）
- 健康环大小会根据窗口宽度自动调整
- 按钮宽度会平均分配可用空间

### 2. 配置化设计（最新）
使用 `LayoutConfig` 结构体集中管理所有布局参数，现已区分水平/垂直边距，并单独提供按钮的水平间距：
```swift
private struct LayoutConfig {
    let windowWidth: CGFloat
    let windowHeight: CGFloat
    let cornerRadius: CGFloat = 12

    // 自适应边距（分离）
    var horizontalPadding: CGFloat { max(16, min(48, windowWidth * 0.15)) }
    var verticalPadding: CGFloat { max(16, min(40, windowHeight * 0.05)) }

    // 标题上边距（可调），默认 15
    var titlePadding: CGFloat { 15 }

    // 水平间距：控制两个按钮之间的距离
    var horizontalSpacing: CGFloat { max(10, min(28, windowWidth * 0.06)) }

    // 图例行高与行距
    var legendItemHeight: CGFloat { 20 }
    var legendSpacing: CGFloat { 3 }

    // 健康环尺寸（320px 特别优化）
    var healthRingSize: CGFloat {
        if windowWidth <= 320 { return min(140, windowWidth * 0.44) }
        return min(160, windowWidth * 0.45)
    }

    // 按钮尺寸
    var buttonHeight: CGFloat { windowWidth <= 320 ? 36 : 38 }
    var buttonWidth: CGFloat {
        // 可用宽度 = 左右 padding + 按钮之间间距
        let available = windowWidth - horizontalPadding * 2 - horizontalSpacing
        return available / 2
    }
}
```

### 3. 实时更新功能
提供 `updateWindowSize()` 方法支持运行时调整：
```swift
// 更新窗口宽度为350px
popupWindow.updateWindowSize(width: 350)

// 更新窗口宽度和高度
popupWindow.updateWindowSize(width: 380, height: 520)
```

## 使用方法

### 初始化时指定尺寸
```swift
// 创建320px宽的窗口（默认）
let popup = StatusBarPopupWindow()

// 创建350px宽的窗口
let popup = StatusBarPopupWindow(width: 350)

// 创建自定义尺寸的窗口
let popup = StatusBarPopupWindow(width: 380, height: 520)
```

### 运行时调整尺寸
```swift
// 调整为280px宽度（紧凑模式）
popup.updateWindowSize(width: 280)

// 调整为400px宽度（宽松模式）
popup.updateWindowSize(width: 400)
```

## 布局规则

### 元素位置计算（最新）
1. **标题**: 顶部居中，使用 `titlePadding` 控制与顶部距离（默认 15）
2. **菜单按钮**: 右上角，X 使用 `horizontalPadding/2`，Y 使用 `verticalPadding/2`
3. **健康环**: 位于“内容区”（标题以下到底部）内自适应居中。空白分配为上方约 75%、下方约 25%，整体稍靠下更稳重
4. **控制按钮**: 健康环下方，两侧按钮宽度自适应；中间间距使用 `horizontalSpacing`
5. **图例**: 按钮下方，行高 `legendItemHeight`、行距 `legendSpacing=3`

### 响应式设计
- **水平/垂直边距**: 分别由 `horizontalPadding`、`verticalPadding` 自适应计算
- **按钮水平间距**: 独立的 `horizontalSpacing`，不再受 `horizontalPadding` 影响
- **健康环大小**: 宽度自适应（320 宽下优先 140px）
- **按钮宽度**: `(windowWidth - horizontalPadding*2 - horizontalSpacing) / 2`
- **图例行距**: 固定 3，紧凑但不拥挤

## 推荐尺寸

| 模式 | 宽度 | 适用场景 |
|------|------|----------|
| 紧凑模式 | 280px | 小屏幕或节省空间 |
| 标准模式 | 320px | 默认推荐尺寸 |
| 舒适模式 | 360px | 大屏幕或更好视觉体验 |
| 宽松模式 | 400px | 超大屏幕或演示用途 |

## 技术实现

### 核心组件
1. **LayoutConfig**: 布局配置结构体
2. **updateLayout()**: 重新布局所有元素
3. **recreateLegend()**: 重新创建图例元素
4. **identifier标识**: 使用NSUserInterfaceItemIdentifier管理动态元素

### 性能优化
- 使用identifier而非tag管理动态元素
- 图例采用重新创建而非逐个更新的策略
- 动画效果平滑，用户体验良好

## 示例代码

```swift
// 在StatusBarController中动态调整窗口大小
class StatusBarController {
    func adjustPopupSize(to width: CGFloat) {
        popupWindow?.updateWindowSize(width: width)
    }
    
    func toggleCompactMode() {
        let currentWidth = popupWindow?.frame.width ?? 320
        let newWidth: CGFloat = currentWidth <= 320 ? 360 : 280
        popupWindow?.updateWindowSize(width: newWidth)
    }
}
```

这个动态布局系统让PomodoroScreen能够适应不同的使用场景和用户偏好，提供更加灵活和用户友好的界面体验。

## 代码重构优化

### 消除重复代码
为了提高代码质量和可维护性，我们对 `StatusBarPopupWindow` 进行了全面重构：

#### 1. 常量提取
- 将图例数据提取为静态常量 `legendItems`，避免在多个方法中重复定义
- 统一管理UI元素的配置信息

#### 2. 方法提取和复用
- `createLegendElements()`: 统一的图例创建逻辑
- `createColorIndicator()`: 可复用的颜色指示器创建方法
- `createLegendLabel()`: 可复用的标签创建方法
- `updateUIElementFrames()`: 统一的UI元素位置更新逻辑
- `removeLegendElements()`: 专门的图例元素清理方法

#### 3. 代码组织优化
- 使用 `// MARK:` 注释对代码进行逻辑分组
- 将相关功能的方法放在一起，提高代码可读性
- 减少方法长度，每个方法职责单一

#### 4. 重构前后对比

**重构前**：
- `setupLegend()` 和 `recreateLegend()` 包含大量重复代码
- 图例数据在两个地方重复定义
- UI元素创建逻辑分散在不同方法中

**重构后**：
- 图例创建逻辑完全复用，零重复代码
- 常量集中管理，便于维护
- 方法职责清晰，便于测试和调试

### 性能和维护性提升
- **减少代码重复**: 从原来的~50行重复代码减少到0行
- **提高可维护性**: 修改图例样式只需要改动一个地方
- **增强可读性**: 方法名称清晰，代码结构层次分明
- **便于扩展**: 新增UI元素类型时，可以复用现有的创建模式

## 最新更新 (2025-09-23)

### 会议模式开关布局优化
- 将会议模式开关移至弹窗最底部
- **标签和开关一起靠右对齐**：标签紧贴开关左侧，间隔8px
- 标签使用固定宽度60px，右对齐显示"会议模式"文字
- iOS风格开关在最右边，整体布局更加紧凑美观

#### 布局配置更新
```swift
// 会议模式开关相关尺寸（iOS风格）
var meetingModeSwitchHeight: CGFloat { IOSSwitchButton.recommendedSize.height }
var meetingModeSwitchWidth: CGFloat { IOSSwitchButton.recommendedSize.width }
var meetingModeLabelWidth: CGFloat { 60 }  // 固定标签宽度

// 会议模式开关位置（标签和开关一起靠右）
var meetingModeSwitchX: CGFloat { windowWidth - horizontalPadding - meetingModeSwitchWidth }
var meetingModeLabelX: CGFloat { 
    // 标签紧贴开关左侧，间隔8px
    meetingModeSwitchX - meetingModeLabelWidth - 8
}
```

#### 视觉效果
- 会议模式标签右对齐显示，文字紧贴开关
- 整体布局更加紧凑，视觉重心在右侧
- 与其他右对齐元素（如菜单按钮）保持一致的设计语言
