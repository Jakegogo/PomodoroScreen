<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥å·¥ä½œæŠ¥å‘Š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fb;
            color: #1f2937;
            overflow-x: hidden;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Header */
        .report-header { text-align: center; margin-bottom: 16px; color: #111827; }
        .report-header h1 { font-size: 32px; font-weight: 800; letter-spacing: .2px; }
        .report-header h1::before { content: 'ğŸ“Š'; display: inline-block; margin-right: 10px; }
        .report-date { margin-top: 6px; font-size: 13px; color: #6b7280; }

        /* Dashboard wrapper */
        .dashboard {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(17,24,39,0.06);
        }

        /* Metric cards */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 28px; }
        .metric-card { background: #f9fafb; border: 1px solid #eef2f7; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 14px; transition: box-shadow .2s ease; }
        .metric-card:hover { box-shadow: 0 6px 16px rgba(17,24,39,0.06); }
        .metric-icon { font-size: 22px; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #edf2ff; color: #3b82f6; margin-right: 6px; }
        .metric-content h3 { font-size: 28px; line-height: 1; font-weight: 800; color: #111827; margin-bottom: 4px; }
        .metric-content p { font-size: 12px; color: #6b7280; letter-spacing: .2px; }
        .pomodoro-card .metric-icon { background:#ffe9ea; color:#ef4444; }
        .work-time-card .metric-icon { background:#e6f3ff; color:#2563eb; }
        .break-time-card .metric-icon { background:#fff3e6; color:#f59e0b; }
        .health-card .metric-icon { background:#e7f8f0; color:#10b981; }

        /* Scores */
        .scores-section { margin-bottom: 16px; }
        .scores-section h2 { margin-bottom: 12px; color:#111827; font-size:18px; }
        .scores-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; text-align: center; }
        .score-item p { margin-top: 8px; font-weight: 600; color: #6b7280; font-size: 12px; }

        /* Calculation trigger */
        .calculation-trigger { 
            text-align: center; 
            margin-top: 16px; 
            padding-top: 12px; 
            border-top: 1px solid #eef2f7;
        }
        .calculation-trigger a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: #6b7280;
            font-weight: 400;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
        }
        .calculation-trigger a:hover {
            color: #4b5563;
            background: rgba(0, 0, 0, 0.02);
        }
        .trigger-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .trigger-icon.rotated {
            transform: rotate(180deg);
        }

        /* Calculation cards */
        .calculation-section { margin: 16px 0 24px; }
        .calculation-section h2 { margin-bottom: 12px; font-size: 18px; color:#111827; }
        
        /* Collapsible functionality */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            transition: color 0.2s ease;
        }
        .collapsible-header:hover {
            color: #4f46e5;
        }
        .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            user-select: none;
        }
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        .calculation-grid {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        .calculation-grid.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        .calculation-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .calculation-card { background:#ffffff; border:1px solid #eef2f7; border-radius:10px; padding:12px; box-shadow: 0 4px 12px rgba(17,24,39,0.04); }
        .calculation-card h3 { margin:0 0 8px 0; font-size:13px; color:#111827; }
        .calculation-formula { margin-bottom: 8px; }
        .formula-title { font-weight:600; color:#4b5563; margin-bottom:4px; font-size:11px; }
        .formula-text { background:#f3f4f6; padding:6px 8px; border-radius:6px; font-family: 'Menlo', 'Monaco', monospace; font-size:10px; color:#111827; line-height: 1.3; }
        .process-title { font-weight:600; color:#4b5563; margin-bottom:4px; font-size:11px; }
        .process-steps { background:#fcfcfd; border:1px solid #eef2f7; border-radius:6px; padding:8px; }
        .process-step { margin-bottom:4px; font-size:10px; color:#6b7280; line-height: 1.3; }
        .process-step:last-child { margin-bottom:0; }
        .process-step .step-label { color:#374151; font-weight:500; }
        .process-step .step-value { color:#2563eb; font-weight:700; }
        .final-result { margin-top:8px; padding:6px 8px; background:#10b981; color:#fff; border-radius:6px; font-weight:700; font-size:11px; }

        /* å“åº”å¼è®¾è®¡ï¼šåœ¨å°å±å¹•ä¸Šè°ƒæ•´å¸ƒå±€ */
        @media (max-width: 1200px) {
            .calculation-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; }
        }
        @media (max-width: 768px) {
            .calculation-grid { grid-template-columns: 1fr; gap: 16px; }
            .calculation-card { padding: 16px; }
            .calculation-card h3 { font-size: 14px; margin-bottom: 10px; }
            .formula-title, .process-title { font-size: 12px; margin-bottom: 6px; }
            .formula-text { font-size: 11px; padding: 8px 10px; }
            .process-step { font-size: 11px; margin-bottom: 6px; }
            .final-result { font-size: 12px; padding: 8px 10px; margin-top: 10px; }
        }

        /* Details */
        .details-section { margin: 8px 0 24px; }
        .details-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; }
        .details-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
        .detail-item { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#ffffff; border:1px solid #eef2f7; border-radius:10px; }
        .detail-left { display:flex; align-items:center; gap:8px; }
        .detail-icon { width:22px; text-align:center; font-size:14px; }
        .detail-label { color:#6b7280; font-size:12px; }
        .detail-value { color:#111827; font-weight:800; font-size:16px; }

        /* Trends */
        .trends-section { margin: 8px 0 24px; }
        .trends-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; }
        .chart-container { background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:16px; height:350px; position:relative; overflow:hidden; }
        .chart-container canvas { max-height: 300px !important; width:100% !important; height:300px !important; }

        /* Heatmap */
        .heatmap-section { margin: 20px 0; }
        .heatmap-section h2 { margin-bottom: 16px; font-size: 20px; color:#111827; }
        .heatmap-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .heatmap-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
        .legend-text { font-size: 12px; color: #6b7280; }
        .pomodoro-extreme-color { background: #b91c3c; }     /* æœ€æ·±çº¢è‰² - åªæœ‰ç•ªèŒ„é’Ÿï¼Œæ— ä¼‘æ¯ */
        .pomodoro-high-ratio-color { background: #d12a68; }  /* æ·±çº¢è‰² - ç•ªèŒ„é’Ÿå ä¸»å¯¼ */
        .pomodoro-medium-ratio-color { background: #ed347c; } /* ä¸­ç­‰çº¢è‰² - å¹³è¡¡çŠ¶æ€ */
        .pomodoro-low-ratio-color { background: #ff9fb3; }   /* æµ…çº¢è‰² - ä¼‘æ¯è¾ƒå¤š */
        .break-color { background: #b2fd00; }
        .interruption-color { background: #04f6d1; }
        .cancelled-color { background: #cc66ff; }
        
        .heatmap-grid { 
            display: grid; 
            grid-template-rows: 30px repeat(24, 1fr); 
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 1px; 
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1px;
            min-height: 600px;
        }
        .heatmap-day-label { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            font-size: 11px; 
            font-weight: 600; 
            color: #374151;
            padding: 4px;
        }
        .heatmap-hour-label { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            font-size: 10px; 
            color: #6b7280;
            padding: 2px;
        }
        .heatmap-cell { 
            background: #ffffff; 
            min-height: 20px; 
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .heatmap-cell:hover { 
            transform: scale(1.1); 
            z-index: 10;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .heatmap-cell.has-activity { border-radius: 2px; }
        
        /* Tooltip */
        .heatmap-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }

        /* Recommendations */
        .recommendations-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; }
        .recommendations-list { display:flex; flex-direction:column; gap:12px; }
         .recommendation-item { padding:14px; border-radius:12px; color:#fff; font-weight:600; letter-spacing:.2px; box-shadow: 0 6px 16px rgba(17,24,39,0.06); }
         .recommendation-item::before { content:'ğŸ’¡'; margin-right:8px; }
         /* Match health ring colors */
         .recommendation-item.rec-work { background: linear-gradient(90deg, #ed347c 0%, #d12a68 100%); }
         .recommendation-item.rec-rest { background: linear-gradient(90deg, #b2fd00 0%, #8fd400 100%); }
         .recommendation-item.rec-focus { background: linear-gradient(90deg, #04f6d1 0%, #03c9a8 100%); }
         .recommendation-item.rec-health { background: linear-gradient(90deg, #cc66ff 0%, #b84dff 100%); }

        /* Reflections */
        .reflection-section { margin-top: 18px; }
        .reflection-title { font-size: 18px; color:#111827; margin-bottom: 12px; }
        .reflection-grid { display: grid; grid-template-columns: 1fr 280px; gap: 16px; }
        .reflection-input { background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:12px; min-height: 120px; resize: vertical; width:100%; font-size: 13px; color:#111827; }
        .mood-row { display:flex; align-items:center; justify-content:space-between; background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:12px 14px; height:120px; }
        .mood-row .mood { font-size: 28px; cursor: default; filter: grayscale(0.05); transition: transform .12s ease; }
        .mood-row .mood:hover { transform: translateY(-2px) scale(1.05); }
    </style>
</head>
<body>
    <div class="container">
        <header class="report-header">
            <h1>ä»Šæ—¥å·¥ä½œæŠ¥å‘Š</h1>
            <p class="report-date" id="reportDate"></p>
        </header>
        
        <div class="dashboard">
            <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
            <div class="metrics-grid">
                <div class="metric-card pomodoro-card">
                    <div class="metric-icon">ğŸ…</div>
                    <div class="metric-content">
                        <h3 id="pomodoroCount">0</h3>
                        <p>å®Œæˆç•ªèŒ„é’Ÿ</p>
                    </div>
                </div>
                
                <div class="metric-card work-time-card">
                    <div class="metric-icon">â°</div>
                    <div class="metric-content">
                        <h3 id="workTime">0h 0m</h3>
                        <p>å·¥ä½œæ—¶é—´</p>
                    </div>
                </div>
                
                <div class="metric-card break-time-card">
                    <div class="metric-icon">â˜•</div>
                    <div class="metric-content">
                        <h3 id="breakTime">0m</h3>
                        <p>ä¼‘æ¯æ—¶é—´</p>
                    </div>
                </div>
                
                <div class="metric-card health-card">
                    <div class="metric-icon">ğŸ’š</div>
                    <div class="metric-content">
                        <h3 id="healthScore">0</h3>
                        <p>å¥åº·è¯„åˆ†</p>
                    </div>
                </div>
            </div>
            
            <!-- è¯„åˆ†ä»ªè¡¨ç›˜ -->
            <div class="scores-section">
                <h2>ğŸ“ˆ ç»¼åˆè¯„ä¼°</h2>
                <div class="scores-grid">
                    <div class="score-item">
                        <canvas id="workIntensityChart" width="120" height="120"></canvas>
                        <p>å·¥ä½œå¼ºåº¦</p>
                    </div>
                    <div class="score-item">
                        <canvas id="restAdequacyChart" width="120" height="120"></canvas>
                        <p>ä¼‘æ¯å……è¶³åº¦</p>
                    </div>
                    <div class="score-item">
                        <canvas id="focusChart" width="120" height="120"></canvas>
                        <p>ä¸“æ³¨åº¦</p>
                    </div>
                    <div class="score-item">
                        <canvas id="healthChart" width="120" height="120"></canvas>
                        <p>å¥åº·åº¦</p>
                    </div>
                </div>
                
                <!-- è¯„åˆ†è®¡ç®—è¯¦æƒ…è§¦å‘é“¾æ¥ -->
                <div class="calculation-trigger">
                    <a href="#" onclick="toggleCalculationDetails(); return false;" id="calculationTriggerLink">
                        ğŸ“Š æŸ¥çœ‹è¯„åˆ†è®¡ç®—è¯¦æƒ…
                        <span class="trigger-icon" id="calculationTriggerIcon">â–¼</span>
                    </a>
                </div>
            </div>
            
            <!-- è®¡ç®—è¿‡ç¨‹è¯¦æƒ… -->
            <div class="calculation-section" id="calculationSection" style="display: none;">
                <h2>ğŸ“Š è¯„åˆ†è®¡ç®—è¯¦æƒ…</h2>
                <div class="calculation-grid" id="calculationGrid">
                    <div class="calculation-card">
                        <h3>ğŸŒ™ ä¼‘æ¯å……è¶³åº¦</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">è®¡ç®—å…¬å¼ï¼š</div>
                            <div class="formula-text">ä¼‘æ¯å……è¶³åº¦ = min(å®é™…ä¼‘æ¯æ—¶é—´ / æœŸæœ›ä¼‘æ¯æ—¶é—´, 1.0) Ã— 100</div>
                        </div>
                        <div class="calculation-process" id="restCalculationProcess">
                            <div class="process-title">è®¡ç®—è¿‡ç¨‹ï¼š</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>ğŸ’ª å·¥ä½œå¼ºåº¦</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">è®¡ç®—å…¬å¼ï¼š</div>
                            <div class="formula-text">å·¥ä½œå¼ºåº¦ = ç•ªèŒ„é’Ÿè¯„åˆ†(50) + ä¼‘æ¯å¹³è¡¡è¯„åˆ†(30) + ä¸€è‡´æ€§è¯„åˆ†(20)</div>
                        </div>
                        <div class="calculation-process" id="workCalculationProcess">
                            <div class="process-title">è®¡ç®—è¿‡ç¨‹ï¼š</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>ğŸ¯ ä¸“æ³¨åº¦</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">è®¡ç®—å…¬å¼ï¼š</div>
                            <div class="formula-text">ä¸“æ³¨åº¦ = max(0, min(100, åŸºç¡€å¾—åˆ† - ä¸­æ–­æƒ©ç½š))</div>
                        </div>
                        <div class="calculation-process" id="focusCalculationProcess">
                            <div class="process-title">è®¡ç®—è¿‡ç¨‹ï¼š</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>ğŸ©º å¥åº·åº¦</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">è®¡ç®—å…¬å¼ï¼š</div>
                            <div class="formula-text">å¥åº·åº¦ = max(0, 100 - ç†¬å¤œæ‰£åˆ† - ä¼‘æ¯æ‰£åˆ† - è¿‡åŠ³æ‰£åˆ†)</div>
                        </div>
                        <div class="calculation-process" id="healthCalculationProcess">
                            <div class="process-title">è®¡ç®—è¿‡ç¨‹ï¼š</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†ç»Ÿè®¡ -->
            <div class="details-section">
                <h2>ğŸ“Š è¯¦ç»†ç»Ÿè®¡</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">ğŸŸ¢</span>
                            <span class="detail-label">çŸ­ä¼‘æ¯æ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="shortBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">â³</span>
                            <span class="detail-label">é•¿ä¼‘æ¯æ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="longBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">âŒ</span>
                            <span class="detail-label">å–æ¶ˆä¼‘æ¯æ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="cancelledBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">ğŸ”’</span>
                            <span class="detail-label">æ¯å±æ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="screenLockCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">ğŸ–¥ï¸</span>
                            <span class="detail-label">å±ä¿æ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="screensaverCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">ğŸ”¥</span>
                            <span class="detail-label">ç†¬å¤œæ¬¡æ•°</span>
                        </div>
                        <span class="detail-value" id="stayUpLateCount">0</span>
                    </div>
                </div>
            </div>
            
            <!-- å‘¨è¶‹åŠ¿å›¾è¡¨ -->
            <div class="trends-section">
                <h2>ğŸ“ˆ ä¸€å‘¨è¶‹åŠ¿</h2>
                <div class="chart-container">
                    <canvas id="weeklyTrendChart" width="800" height="300"></canvas>
                </div>
            </div>
            
            <!-- æ´»åŠ¨çƒ­åŠ›å›¾ -->
            <div class="heatmap-section">
                <h2>ğŸ”¥ æ´»åŠ¨çƒ­åŠ›å›¾</h2>
                <div class="heatmap-container">
                    <div class="heatmap-legend">
                        <div class="legend-item">
                            <span class="legend-color pomodoro-extreme-color"></span>
                            <span class="legend-text">çº¯ç•ªèŒ„é’Ÿ</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-high-ratio-color"></span>
                            <span class="legend-text">ç•ªèŒ„é’Ÿ(ä¸»å¯¼)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-medium-ratio-color"></span>
                            <span class="legend-text">ç•ªèŒ„é’Ÿ(å¹³è¡¡)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-low-ratio-color"></span>
                            <span class="legend-text">ç•ªèŒ„é’Ÿ(ä¼‘æ¯å¤š)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color break-color"></span>
                            <span class="legend-text">çº¯ä¼‘æ¯</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color interruption-color"></span>
                            <span class="legend-text">ä¸­æ–­</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color cancelled-color"></span>
                            <span class="legend-text">å–æ¶ˆä¼‘æ¯</span>
                        </div>
                    </div>
                    <div class="heatmap-grid" id="heatmapGrid">
                        <!-- çƒ­åŠ›å›¾å†…å®¹å°†ç”±JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å¥åº·å»ºè®® -->
            <div class="recommendations-section">
                <h2>ğŸ’¡ å¥åº·å»ºè®®</h2>
                <div id="recommendationsList" class="recommendations-list">
                </div>
            </div>

            <!-- ä½ çš„æ„Ÿå—ï¼ˆç§»è‡³åº•éƒ¨ï¼‰ -->
            <div class="reflection-section">
                <h2 class="reflection-title">ğŸ“ ä½ çš„æ„Ÿå—</h2>
                <div class="reflection-grid">
                    <textarea class="reflection-input" placeholder="è®°å½•ä»Šå¤©çš„æƒ³æ³•ä¸æ„Ÿå—..."></textarea>
                    <div class="mood-row" aria-hidden="true">
                        <span class="mood">ğŸ˜</span>
                        <span class="mood">ğŸ˜</span>
                        <span class="mood">ğŸ™‚</span>
                        <span class="mood">ğŸ˜Š</span>
                        <span class="mood">ğŸ˜„</span>
                        <span class="mood">ğŸ¤©</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–çš„æ ‡å¿—
        var reportInitialized = false;
        
        // åˆå§‹åŒ–æŠ¥å‘Š
        function initializeReport() {
            if (reportInitialized) {
                console.log('Report already initialized, skipping...');
                return;
            }
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded, retrying in 500ms...');
                setTimeout(initializeReport, 500);
                return;
            }
            
            try {
                console.log('Starting report initialization...');
                console.log('Chart.js version:', Chart.version);
                console.log('Report data:', reportData);
                
                updateBasicMetrics();
                createScoreCharts();
                showCalculationDetails();
                createWeeklyTrendChart();
                createActivityHeatmap();
                showRecommendations();
                reportInitialized = true;
                console.log('Report initialized successfully');
            } catch (error) {
                console.error('Error initializing report:', error);
                console.error('Stack trace:', error.stack);
            }
        }
        
        // æ›´æ–°åŸºæœ¬æŒ‡æ ‡
        function updateBasicMetrics() {
            const daily = reportData.daily;
            
            // æ›´æ–°æ—¥æœŸ
            document.getElementById('reportDate').textContent = 
                new Date(daily.date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            
            // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
            document.getElementById('pomodoroCount').textContent = daily.completedPomodoros;
            
            const workHours = Math.floor(daily.totalWorkTime / 3600);
            const workMinutes = Math.floor((daily.totalWorkTime % 3600) / 60);
            document.getElementById('workTime').textContent = workHours + 'h ' + workMinutes + 'm';
            
            const breakMinutes = Math.floor(daily.totalBreakTime / 60);
            document.getElementById('breakTime').textContent = breakMinutes + 'm';
            
            document.getElementById('healthScore').textContent = Math.round(daily.healthScore);
            
            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
            document.getElementById('shortBreakCount').textContent = daily.shortBreakCount;
            document.getElementById('longBreakCount').textContent = daily.longBreakCount;
            document.getElementById('cancelledBreakCount').textContent = daily.cancelledBreakCount;
            document.getElementById('screenLockCount').textContent = daily.screenLockCount;
            document.getElementById('screensaverCount').textContent = daily.screensaverCount;
            document.getElementById('stayUpLateCount').textContent = daily.stayUpLateCount;
        }
        
        // åˆ›å»ºè¯„åˆ†åœ†ç¯å›¾
        function createScoreCharts() {
            const daily = reportData.daily;
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, using fallback display');
                createFallbackScoreDisplay();
                return;
            }
            
            createDoughnutChart('workIntensityChart', daily.workIntensityScore, 'å·¥ä½œå¼ºåº¦', '#ed347c');
            createDoughnutChart('restAdequacyChart', daily.restAdequacyScore, 'ä¼‘æ¯å……è¶³åº¦', '#b2fd00');
            createDoughnutChart('focusChart', daily.focusScore, 'ä¸“æ³¨åº¦', '#04f6d1');
            createDoughnutChart('healthChart', daily.healthScore, 'å¥åº·åº¦', '#cc66ff');
        }
        
        // Chart.jsä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ˜¾ç¤º
        function createFallbackScoreDisplay() {
            const daily = reportData.daily;
            const scores = [
                { id: 'workIntensityChart', score: daily.workIntensityScore, label: 'å·¥ä½œå¼ºåº¦' },
                { id: 'restAdequacyChart', score: daily.restAdequacyScore, label: 'ä¼‘æ¯å……è¶³åº¦' },
                { id: 'focusChart', score: daily.focusScore, label: 'ä¸“æ³¨åº¦' },
                { id: 'healthChart', score: daily.healthScore, label: 'å¥åº·åº¦' }
            ];
            
            scores.forEach(item => {
                const canvas = document.getElementById(item.id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    // ç®€å•çš„æ–‡æœ¬æ˜¾ç¤º
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#333';
                    ctx.fillText(Math.round(item.score), canvas.width/2, canvas.height/2);
                }
            });
        }
        
        function createDoughnutChart(canvasId, score, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            if (window[canvasId + '_chart'] && typeof window[canvasId + '_chart'].destroy === 'function') {
                window[canvasId + '_chart'].destroy();
            }
            
            window[canvasId + '_chart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [color, '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    elements: {
                        arc: {
                            borderWidth: 0
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [{
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = color;
                        ctx.fillText(Math.round(score), centerX, centerY);
                        ctx.restore();
                    }
                }]
            });
        }
        
        // åˆ›å»ºå‘¨è¶‹åŠ¿å›¾
        function createWeeklyTrendChart() {
            console.log('Creating weekly trend chart...');
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, showing fallback message');
                const canvas = document.getElementById('weeklyTrendChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#666';
                    ctx.fillText('å›¾è¡¨åŠ è½½ä¸­...', canvas.width/2, canvas.height/2);
                }
                return;
            }
            
            const weekly = reportData.weekly;
            console.log('Weekly data:', weekly);
            
            if (!weekly || !weekly.dailyTrend || weekly.dailyTrend.length === 0) {
                console.warn('No weekly trend data available, showing empty chart');
                // æ˜¾ç¤ºç©ºå›¾è¡¨ï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const emptyWeekly = {
                    dailyTrend: []
                };
                createWeeklyTrendChartWithData(emptyWeekly);
                return;
            }
            
            createWeeklyTrendChartWithData(weekly);
        }
        
        function createWeeklyTrendChartWithData(weekly) {
            const canvas = document.getElementById('weeklyTrendChart');
            // è®©å›¾è¡¨è‡ªèº«æŒ‰å®¹å™¨å®½åº¦è‡ªé€‚åº”
            canvas.removeAttribute('width');
            canvas.removeAttribute('height');
            canvas.style.width = '100%';
            canvas.style.height = 'auto';
            const ctx = canvas.getContext('2d');
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            if (window.weeklyTrendChart && typeof window.weeklyTrendChart.destroy === 'function') {
                window.weeklyTrendChart.destroy();
            }
            
            // ä½¿ç”¨åç«¯æä¾›çš„å®é™…æ—¥æœŸæ•°æ®ç”Ÿæˆæ ‡ç­¾
            const labels = weekly.dailyTrend.length > 0 
                ? weekly.dailyTrend.map((day, index) => {
                    const date = new Date(day.date);
                    const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€å¤©ï¼ˆä»Šå¤©ï¼‰
                    const isToday = index === weekly.dailyTrend.length - 1;
                    return isToday ? `${weekdayLabel}\n(ä»Šå¤©)` : weekdayLabel;
                })
                : Array.from({ length: 7 }, (_, index) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (6 - index)); // è¿‡å»7å¤©ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
                    const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                    // æœ€åä¸€ä¸ªç´¢å¼•æ˜¯ä»Šå¤©
                    const isToday = index === 6;
                    return isToday ? `${weekdayLabel}\n(ä»Šå¤©)` : weekdayLabel;
                });
            console.log('Chart labels:', labels);
            
            window.weeklyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç•ªèŒ„é’Ÿæ•°é‡',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.pomodoros || 0)
                                : Array(7).fill(0),
                            borderColor: '#ed347c',
                            backgroundColor: 'rgba(237, 52, 124, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ä¼‘æ¯æ¬¡æ•°',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.breakCount || 0)
                                : Array(7).fill(0),
                            borderColor: '#b2fd00',
                            backgroundColor: 'rgba(178, 253, 0, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å¥åº·åº¦',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.healthScore || 0)
                                : Array(7).fill(0),
                            borderColor: '#cc66ff',
                            backgroundColor: 'rgba(204, 102, 255, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    // å…³é”®è®¾ç½®ï¼šç”±å›¾è¡¨è‡ªèº«æ§åˆ¶å°ºå¯¸ï¼Œéšå®¹å™¨å®½åº¦å˜åŒ–
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.6, // å®½é«˜æ¯”ï¼Œé¿å…è¢«æ‹‰ä¼¸ï¼ˆçº¦ç­‰äº 800/308ï¼‰
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ•°é‡'
                            },
                            min: 0
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å¥åº·åº¦è¯„åˆ†'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'æœ¬å‘¨å·¥ä½œè¶‹åŠ¿'
                        }
                    }
                }
            });
        }
        
        // åˆ›å»ºæ´»åŠ¨çƒ­åŠ›å›¾ï¼ˆçºµå‘å¸ƒå±€ï¼‰
        function createActivityHeatmap() {
            console.log('Creating activity heatmap...');
            
            const heatmapGrid = document.getElementById('heatmapGrid');
            if (!heatmapGrid) {
                console.warn('Heatmap grid element not found');
                return;
            }
            
            // è·å–çƒ­åŠ›å›¾æ•°æ®ï¼ˆä»æ•°æ®åº“æˆ–æ¨¡æ‹Ÿæ•°æ®ï¼‰
            const weekData = getHeatmapDataFromDB();
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            heatmapGrid.innerHTML = '';
            
            // è®¡ç®—ä»Šå¤©å’Œè¿‡å»7å¤©å¼€å§‹æ—¥æœŸï¼Œç”¨äºæ•°æ®åˆ¤æ–­ï¼ˆä¸ä¸€å‘¨è¶‹åŠ¿å›¾è¡¨ä¿æŒä¸€è‡´ï¼‰
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - 6); // è¿‡å»7å¤©ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
            
            console.log('ğŸ“… Today:', today.toDateString());
            console.log('ğŸ“… Week start:', weekStart.toDateString());
            console.log('ğŸ“… Days to show: 7 (full week)');
            
            // æ ¹æ®å®é™…æ—¥æœŸç”Ÿæˆæ ‡ç­¾ï¼ˆè¿‡å»7å¤©ï¼‰
            const dayLabels = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                dayLabels.push(weekdayLabel);
            }
            console.log('ğŸ“… Heatmap day labels:', dayLabels);
            const daysToShow = 7; // å›ºå®šæ˜¾ç¤º7å¤©
            
            // CSS Gridæ¨¡æ¿å›ºå®šä¸º7å¤©
            heatmapGrid.style.gridTemplateColumns = `40px repeat(7, 1fr)`;
            
            // åˆ›å»ºè¡¨å¤´ - å·¦ä¸Šè§’ç©ºæ ¼ + æ—¥æœŸæ ‡ç­¾
            heatmapGrid.appendChild(createEmptyCell()); // å·¦ä¸Šè§’ç©ºæ ¼
            dayLabels.forEach((dayLabel, dayIndex) => {
                const dayCell = document.createElement('div');
                dayCell.className = 'heatmap-day-label';
                
                // è®¡ç®—å…·ä½“æ—¥æœŸ
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + dayIndex);
                const dateStr = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                
                dayCell.textContent = `${dayLabel}\n${dateStr}`;
                dayCell.style.whiteSpace = 'pre-line';
                dayCell.style.textAlign = 'center';
                dayCell.style.fontSize = '12px';
                dayCell.style.lineHeight = '1.2';
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è¯†
                if (isSameDay(currentDate, today)) {
                    dayCell.style.fontWeight = 'bold';
                    dayCell.style.color = '#007AFF';
                    dayCell.title = 'ä»Šå¤©';
                }
                
                heatmapGrid.appendChild(dayCell);
            });
            
            // åˆ›å»º24å°æ—¶çš„æ•°æ®è¡Œ
            for (let hour = 0; hour < 24; hour++) {
                // æ—¶é—´æ ‡ç­¾ï¼ˆå·¦ä¾§ï¼‰
                const hourCell = document.createElement('div');
                hourCell.className = 'heatmap-hour-label';
                hourCell.textContent = hour.toString().padStart(2, '0') + ':00';
                heatmapGrid.appendChild(hourCell);
                
                // æ¯ä¸€å¤©çš„æ•°æ®ï¼ˆæ˜¾ç¤ºå®Œæ•´ä¸€å‘¨ï¼ŒåŒ…æ‹¬æœªæ¥æ—¥æœŸï¼‰
                for (let dayIndex = 0; dayIndex < daysToShow; dayIndex++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    // è®¡ç®—å½“å‰æ—¥æœŸ
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + dayIndex);
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ
                    const isFutureDate = currentDate > today;
                    
                    // è·å–æ•°æ®ï¼ˆå¦‚æœæ˜¯æœªæ¥æ—¥æœŸæˆ–æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä¸ºç©ºï¼‰
                    const dayData = weekData[dayIndex];
                    const hourData = dayData && dayData[hour] && !isFutureDate ? dayData[hour] : {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // åªæœ‰å½“ä¸æ˜¯æœªæ¥æ—¥æœŸä¸”æœ‰æ´»åŠ¨æ—¶æ‰æ˜¾ç¤ºæ•°æ®
                    if (!isFutureDate && hourData.hasActivity) {
                        cell.classList.add('has-activity');
                        const color = getActivityColor(hourData.primaryActivity, hourData);
                        cell.style.backgroundColor = color;
                        // æ ¹æ®æ´»åŠ¨å¼ºåº¦è°ƒæ•´é€æ˜åº¦
                        const intensity = Math.min(hourData.totalActivities / 5, 1); // æœ€å¤§5ä¸ªæ´»åŠ¨ä¸ºæ»¡å¼ºåº¦
                        const opacity = 0.3 + (intensity * 0.7); // 0.3-1.0çš„é€æ˜åº¦èŒƒå›´
                        cell.style.opacity = opacity;
                        
                        // è°ƒè¯•ä¿¡æ¯ï¼šè®°å½•è®¾ç½®äº†æ ·å¼çš„å•å…ƒæ ¼ (å·²æ³¨é‡Šä»¥å‡å°‘æ—¥å¿—)
                        // if (dayIndex === 0 && hour < 12) { // åªè®°å½•å‘¨ä¸€ä¸Šåˆçš„å‰å‡ ä¸ªå°æ—¶é¿å…æ—¥å¿—è¿‡å¤š
                        //     console.log(`ğŸ¨ Styling cell [${dayLabels[dayIndex]}, ${hour}:00]:`, {
                        //         primaryActivity: hourData.primaryActivity,
                        //         totalActivities: hourData.totalActivities,
                        //         color: color,
                        //         opacity: opacity,
                        //         activities: hourData.activities
                        //     });
                        // }
                    }
                    
                    // ä¸ºæœªæ¥æ—¥æœŸæ·»åŠ ç‰¹æ®Šæ ·å¼ï¼ˆå¯é€‰ï¼‰
                    if (isFutureDate) {
                        cell.style.opacity = '0.3';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                    
                    // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœå’Œå·¥å…·æç¤º
                    const currentDayLabel = dayLabels[dayIndex];
                    cell.addEventListener('mouseenter', (e) => showHeatmapTooltip(e, currentDayLabel, hour, hourData, isFutureDate));
                    cell.addEventListener('mouseleave', hideHeatmapTooltip);
                    
                    heatmapGrid.appendChild(cell);
                }
            }
            
            console.log('Activity heatmap created successfully');
        }
        
        // åˆ›å»ºç©ºç™½å•å…ƒæ ¼
        function createEmptyCell() {
            const cell = document.createElement('div');
            cell.className = 'heatmap-day-label';
            cell.style.background = 'transparent';
            return cell;
        }
        
        // ä»æ•°æ®åº“è·å–çƒ­åŠ›å›¾æ•°æ®
        function getHeatmapDataFromDB() {
            console.log('ğŸ” Fetching heatmap data from database...');
            console.log('ğŸ“Š reportData:', reportData);
            
            // å°è¯•ä»reportDataä¸­è·å–çƒ­åŠ›å›¾æ•°æ®
            if (reportData && reportData.weekly && reportData.weekly.heatmapData) {
                console.log('âœ… Using real heatmap data from database');
                console.log('ğŸ“… Raw heatmap data length:', reportData.weekly.heatmapData.length);
                console.log('ğŸ“„ Sample heatmap events:', reportData.weekly.heatmapData.slice(0, 5));
                return processHeatmapData(reportData.weekly.heatmapData);
            }
            
            // å¦‚æœæ²¡æœ‰çœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            console.log('âš ï¸ No real heatmap data available, using simulated data');
            console.log('ğŸ”§ reportData structure check:');
            console.log('  - reportData exists:', !!reportData);
            console.log('  - reportData.weekly exists:', !!(reportData && reportData.weekly));
            console.log('  - reportData.weekly.heatmapData exists:', !!(reportData && reportData.weekly && reportData.weekly.heatmapData));
            return generateSimulatedHeatmapData();
        }
        
        // å¤„ç†ä»æ•°æ®åº“è·å–çš„çƒ­åŠ›å›¾æ•°æ®ï¼ˆæŒ‰å¤©ç»Ÿè®¡æ ¼å¼ï¼‰
        function processHeatmapData(rawData) {
            console.log('ğŸ”„ Processing heatmap data, total daily records:', rawData.length);
            console.log('ğŸ“‹ Sample daily record:', rawData[0]);
            
            const weekData = [];
            let totalProcessedActivities = 0;
            
            // åˆå§‹åŒ–7å¤©x24å°æ—¶çš„æ•°æ®ç»“æ„
            for (let day = 0; day < 7; day++) {
                const dayData = [];
                
                // æŸ¥æ‰¾å¯¹åº”å¤©çš„æ•°æ®è®°å½•
                const dayRecord = rawData.find(record => record.dayOffset === day);
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // å¦‚æœæ‰¾åˆ°è¯¥å¤©çš„è®°å½•ï¼ŒæŸ¥æ‰¾è¯¥å°æ—¶çš„æ´»åŠ¨
                    if (dayRecord && dayRecord.activities && dayRecord.activities[`hour_${hour}`]) {
                        const hourActivity = dayRecord.activities[`hour_${hour}`];
                        
                        hourData.hasActivity = true;
                        hourData.primaryActivity = hourActivity.primaryActivity;
                        hourData.totalActivities = hourActivity.totalActivities;
                        
                        // è½¬æ¢activitiesæ ¼å¼
                        Object.entries(hourActivity.activities).forEach(([type, count]) => {
                            hourData.activities.push({ type, count });
                        });
                        
                        totalProcessedActivities += hourActivity.totalActivities;
                        
                        console.log(`ğŸ“Š Found activities for day ${day}, hour ${hour}: ${hourActivity.totalActivities} total, primary: ${hourActivity.primaryActivity}`);
                    }
                    
                    dayData.push(hourData);
                }
                weekData.push(dayData);
            }
            
            console.log(`âœ… Processed ${totalProcessedActivities} activities total from daily records`);
            console.log('ğŸ“ˆ Final week data structure:', weekData);
            return weekData;
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿçƒ­åŠ›å›¾æ•°æ®ï¼ˆå½“æ•°æ®åº“æ•°æ®ä¸å¯ç”¨æ—¶ï¼‰
        function generateSimulatedHeatmapData() {
            console.log('ğŸ­ Generating simulated heatmap data...');
            const weekData = [];
            let simulatedActivities = 0;
            
            for (let day = 0; day < 7; day++) {
                const dayData = [];
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // æ¨¡æ‹Ÿå·¥ä½œæ—¶é—´çš„æ´»åŠ¨æ•°æ®
                    if (hour >= 9 && hour <= 18 && day < 5) { // å·¥ä½œæ—¥9-18ç‚¹
                        const rand = Math.random();
                        if (rand > 0.3) { // 70%æ¦‚ç‡æœ‰æ´»åŠ¨
                            hourData.hasActivity = true;
                            const activityCount = Math.floor(Math.random() * 3) + 1;
                            hourData.totalActivities = activityCount;
                            simulatedActivities += activityCount;
                            
                            if (rand > 0.8) {
                                hourData.primaryActivity = 'interruption';
                                hourData.activities.push({ type: 'interruption', count: activityCount });
                            } else if (rand > 0.6) {
                                hourData.primaryActivity = 'cancelled';
                                hourData.activities.push({ type: 'cancelled', count: activityCount });
                            } else if (rand > 0.4) {
                                hourData.primaryActivity = 'break';
                                hourData.activities.push({ type: 'break', count: activityCount });
                            } else {
                                hourData.primaryActivity = 'pomodoro';
                                hourData.activities.push({ type: 'pomodoro', count: activityCount });
                            }
                            
                            // console.log(`ğŸ¯ Simulated activity: ${hourData.primaryActivity} on day ${day}, hour ${hour}`);
                        }
                    }
                    
                    dayData.push(hourData);
                }
                weekData.push(dayData);
            }
            
            console.log(`ğŸ­ Generated ${simulatedActivities} simulated activities total`);
            return weekData;
        }
        
        // æ ¹æ®æ´»åŠ¨ç±»å‹è·å–é¢œè‰²
        function getActivityColor(activityType, hourData = null) {
            // å¦‚æœæ˜¯ç•ªèŒ„é’Ÿï¼Œæ˜¾ç¤ºçº¢è‰²ï¼ˆä¸å·¥ä½œå¼ºåº¦é¢œè‰²ä¸€è‡´ï¼‰ï¼Œæ ¹æ®ç•ªèŒ„é’Ÿ/ä¼‘æ¯æ¯”ä¾‹è°ƒæ•´æµ“æ·¡
            if (activityType === 'pomodoro') {
                if (hourData && hourData.activities) {
                    // è®¡ç®—ç•ªèŒ„é’Ÿå’Œä¼‘æ¯çš„æ•°é‡
                    let pomodoroCount = 0;
                    let breakCount = 0;
                    
                    hourData.activities.forEach(activity => {
                        if (activity.type === 'pomodoro') {
                            pomodoroCount += activity.count;
                        } else if (activity.type === 'break') {
                            breakCount += activity.count;
                        }
                    });
                    
                    // è®¡ç®—ç•ªèŒ„é’Ÿ/ä¼‘æ¯æ¯”ä¾‹ï¼Œæ¯”ä¾‹è¶Šå¤§çº¢è‰²è¶Šæµ“
                    const totalCount = pomodoroCount + breakCount;
                    if (totalCount > 0) {
                        const pomodoroRatio = pomodoroCount / totalCount;
                        // æ ¹æ®æ¯”ä¾‹è°ƒæ•´çº¢è‰²æµ“åº¦ï¼šæ¯”ä¾‹é«˜ç”¨æ·±çº¢è‰²ï¼Œæ¯”ä¾‹ä½ç”¨æµ…çº¢è‰²
                        if (pomodoroRatio === 1.0) {
                            return '#b91c3c'; // æœ€æ·±çº¢è‰² - åªæœ‰ç•ªèŒ„é’Ÿï¼Œæ— ä¼‘æ¯ï¼ˆå·¥ä½œå¼ºåº¦æé«˜ï¼‰
                        } else if (pomodoroRatio >= 0.8) {
                            return '#d12a68'; // æ·±çº¢è‰² - ç•ªèŒ„é’Ÿå ä¸»å¯¼
                        } else if (pomodoroRatio >= 0.5) {
                            return '#ed347c'; // ä¸­ç­‰çº¢è‰² - å¹³è¡¡çŠ¶æ€
                        } else {
                            return '#ff9fb3'; // æµ…çº¢è‰² - ä¼‘æ¯è¾ƒå¤š
                        }
                    }
                }
                // é»˜è®¤çº¢è‰²ï¼ˆä¸å·¥ä½œå¼ºåº¦é¢œè‰²ä¸€è‡´ï¼‰
                return '#ed347c';
            }
            
            // å¦‚æœè¯¥å°æ—¶åªæœ‰ä¼‘æ¯ï¼Œæ˜¾ç¤ºç»¿è‰²ï¼ˆä¸ä¼‘æ¯å……è¶³åº¦é¢œè‰²ä¸€è‡´ï¼‰
            if (activityType === 'break') {
                return '#b2fd00'; // ç»¿è‰²
            }
            
            const colors = {
                'pomodoro': '#ed347c', // çº¢è‰²ç•ªèŒ„é’Ÿé¢œè‰²
                'break': '#b2fd00',    // ç»¿è‰²ä¼‘æ¯
                'interruption': '#04f6d1',
                'cancelled': '#cc66ff'
            };
            return colors[activityType] || '#ffffff';
        }
        
        // æ˜¾ç¤ºå·¥å…·æç¤º
        function showHeatmapTooltip(event, dayLabel, hour, hourData, isFutureDate = false) {
            const tooltip = document.createElement('div');
            tooltip.className = 'heatmap-tooltip';
            
            let content = `${dayLabel} ${hour.toString().padStart(2, '0')}:00`;
            
            if (isFutureDate) {
                content += `<br>æœªæ¥æ—¶é—´`;
            } else if (hourData.hasActivity) {
                content += `<br>`;
                
                // è®¡ç®—ç•ªèŒ„é’Ÿå’Œä¼‘æ¯çš„æ•°é‡ç”¨äºæ˜¾ç¤ºæ¯”ä¾‹
                let pomodoroCount = 0;
                let breakCount = 0;
                
                hourData.activities.forEach(activity => {
                    const activityNames = {
                        'pomodoro': 'ç•ªèŒ„é’Ÿ',
                        'break': 'ä¼‘æ¯',
                        'interruption': 'ä¸­æ–­',
                        'cancelled': 'å–æ¶ˆä¼‘æ¯'
                    };
                    content += `${activityNames[activity.type]}: ${activity.count}æ¬¡<br>`;
                    
                    // ç»Ÿè®¡ç•ªèŒ„é’Ÿå’Œä¼‘æ¯æ•°é‡
                    if (activity.type === 'pomodoro') {
                        pomodoroCount += activity.count;
                    } else if (activity.type === 'break') {
                        breakCount += activity.count;
                    }
                });
                
                // å¦‚æœæœ‰ç•ªèŒ„é’Ÿï¼Œæ˜¾ç¤ºæ¯”ä¾‹æˆ–å¼ºåº¦ä¿¡æ¯
                if (pomodoroCount > 0) {
                    if (breakCount > 0) {
                        // æœ‰ç•ªèŒ„é’Ÿå’Œä¼‘æ¯ï¼Œæ˜¾ç¤ºæ¯”ä¾‹
                        const totalCount = pomodoroCount + breakCount;
                        const pomodoroRatio = (pomodoroCount / totalCount * 100).toFixed(0);
                        content += `<br>ç•ªèŒ„é’Ÿæ¯”ä¾‹: ${pomodoroRatio}%`;
                    } else {
                        // åªæœ‰ç•ªèŒ„é’Ÿï¼Œæ— ä¼‘æ¯
                        content += `<br>âš ï¸ é«˜å¼ºåº¦å·¥ä½œï¼Œæ— ä¼‘æ¯`;
                    }
                }
            } else {
                content += `<br>æ— æ´»åŠ¨`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            
            document.body.appendChild(tooltip);
        }
        
        // éšè—å·¥å…·æç¤º
        function hideHeatmapTooltip() {
            const tooltips = document.querySelectorAll('.heatmap-tooltip');
            tooltips.forEach(tooltip => tooltip.remove());
        }
        
        // æ˜¾ç¤ºè®¡ç®—è¯¦æƒ…
        function showCalculationDetails() {
            console.log('Showing calculation details...');
            const daily = reportData.daily;
            
            if (!daily) {
                console.warn('No daily data available for calculation details');
                return;
            }
            
            // æ˜¾ç¤ºä¼‘æ¯å……è¶³åº¦è®¡ç®—è¿‡ç¨‹
            showRestCalculation(daily);
            
            // æ˜¾ç¤ºå·¥ä½œå¼ºåº¦è®¡ç®—è¿‡ç¨‹
            showWorkIntensityCalculation(daily);
            
            // æ˜¾ç¤ºä¸“æ³¨åº¦è®¡ç®—è¿‡ç¨‹
            showFocusCalculation(daily);
            
            // æ˜¾ç¤ºå¥åº·åº¦è®¡ç®—è¿‡ç¨‹
            showHealthCalculation(daily);
        }
        
        // ä¼‘æ¯å……è¶³åº¦è®¡ç®—è¿‡ç¨‹
        function showRestCalculation(daily) {
            const container = document.querySelector('#restCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalBreakTime = daily.totalBreakTime || 0;
            const expectedBreakTime = completedPomodoros * 5 * 60; // 5åˆ†é’Ÿ * 60ç§’
            const actualBreakRatio = expectedBreakTime > 0 ? totalBreakTime / expectedBreakTime : 0;
            const finalScore = Math.min(actualBreakRatio, 1.0) * 100;
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">å®Œæˆç•ªèŒ„é’Ÿæ•°ï¼š</span>
                    <span class="step-value">${completedPomodoros} ä¸ª</span>
                </div>
                <div class="process-step">
                    <span class="step-label">å®é™…ä¼‘æ¯æ—¶é—´ï¼š</span>
                    <span class="step-value">${Math.round(totalBreakTime / 60)} åˆ†é’Ÿ</span>
                </div>
                <div class="process-step">
                    <span class="step-label">æœŸæœ›ä¼‘æ¯æ—¶é—´ï¼š</span>
                    <span class="step-value">${Math.round(expectedBreakTime / 60)} åˆ†é’Ÿ (${completedPomodoros} Ã— 5åˆ†é’Ÿ)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">ä¼‘æ¯æ—¶é—´æ¯”ä¾‹ï¼š</span>
                    <span class="step-value">${(actualBreakRatio * 100).toFixed(1)}%</span>
                </div>
                <div class="final-result">
                    æœ€ç»ˆå¾—åˆ†ï¼š${Math.round(finalScore)} åˆ†
                </div>
            `;
        }
        
        // å·¥ä½œå¼ºåº¦è®¡ç®—è¿‡ç¨‹
        function showWorkIntensityCalculation(daily) {
            const container = document.querySelector('#workCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalWorkTime = daily.totalWorkTime || 0;
            const totalBreakTime = daily.totalBreakTime || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            
            // ç•ªèŒ„é’Ÿè¯„åˆ† (50åˆ†)
            const idealPomodoros = 8.0;
            const pomodoroScore = Math.min(completedPomodoros / idealPomodoros, 1.0) * 50;
            
            // ä¼‘æ¯å¹³è¡¡è¯„åˆ† (30åˆ†)
            const workBreakRatio = totalWorkTime > 0 ? totalBreakTime / totalWorkTime : 0;
            const idealBreakRatio = 0.25;
            const breakScore = Math.min(workBreakRatio / idealBreakRatio, 1.0) * 30;
            
            // ä¸€è‡´æ€§è¯„åˆ† (20åˆ†)
            const consistencyScore = cancelledBreakCount === 0 ? 20.0 : Math.max(0, 20 - cancelledBreakCount * 5);
            
            const finalScore = pomodoroScore + breakScore + consistencyScore;
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">ç•ªèŒ„é’Ÿè¯„åˆ†ï¼š</span>
                    <span class="step-value">${pomodoroScore.toFixed(1)} åˆ† (${completedPomodoros}/8 Ã— 50)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">å·¥ä½œä¼‘æ¯æ¯”ä¾‹ï¼š</span>
                    <span class="step-value">${(workBreakRatio * 100).toFixed(1)}% (ç†æƒ³25%)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">ä¼‘æ¯å¹³è¡¡è¯„åˆ†ï¼š</span>
                    <span class="step-value">${breakScore.toFixed(1)} åˆ†</span>
                </div>
                <div class="process-step">
                    <span class="step-label">ä¸€è‡´æ€§è¯„åˆ†ï¼š</span>
                    <span class="step-value">${consistencyScore.toFixed(1)} åˆ† (å–æ¶ˆä¼‘æ¯${cancelledBreakCount}æ¬¡)</span>
                </div>
                <div class="final-result">
                    æœ€ç»ˆå¾—åˆ†ï¼š${Math.round(finalScore)} åˆ†
                </div>
            `;
        }
        
        // ä¸“æ³¨åº¦è®¡ç®—è¿‡ç¨‹
        function showFocusCalculation(daily) {
            const container = document.querySelector('#focusCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            const screenLockCount = daily.screenLockCount || 0;
            
            const baseScore = completedPomodoros * 10;
            const interruptionPenalty = (cancelledBreakCount + screenLockCount) * 5;
            const finalScore = Math.max(0, Math.min(100, baseScore - interruptionPenalty));
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">åŸºç¡€å¾—åˆ†ï¼š</span>
                    <span class="step-value">${baseScore} åˆ† (${completedPomodoros} Ã— 10)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">å–æ¶ˆä¼‘æ¯æ¬¡æ•°ï¼š</span>
                    <span class="step-value">${cancelledBreakCount} æ¬¡</span>
                </div>
                <div class="process-step">
                    <span class="step-label">æ¯å±æ¬¡æ•°ï¼š</span>
                    <span class="step-value">${screenLockCount} æ¬¡</span>
                </div>
                <div class="process-step">
                    <span class="step-label">ä¸­æ–­æƒ©ç½šï¼š</span>
                    <span class="step-value">-${interruptionPenalty} åˆ† ((${cancelledBreakCount} + ${screenLockCount}) Ã— 5)</span>
                </div>
                <div class="final-result">
                    æœ€ç»ˆå¾—åˆ†ï¼š${Math.round(finalScore)} åˆ†
                </div>
            `;
        }
        
        // å¥åº·åº¦è®¡ç®—è¿‡ç¨‹
        function showHealthCalculation(daily) {
            const container = document.querySelector('#healthCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalWorkTime = daily.totalWorkTime || 0;
            const stayUpLateCount = daily.stayUpLateCount || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æ´»åŠ¨ï¼Œè¿”å›è¾ƒä½çš„åŸºç¡€åˆ†æ•°
            if (completedPomodoros === 0 && totalWorkTime === 0) {
                container.innerHTML = `
                    <div class="process-step">
                        <span class="step-label">æ´»åŠ¨çŠ¶æ€ï¼š</span>
                        <span class="step-value">æ— å·¥ä½œè®°å½•</span>
                    </div>
                    <div class="final-result">
                        åŸºç¡€å¾—åˆ†ï¼š20 åˆ†
                    </div>
                `;
                return;
            }
            
            let score = 100.0;
            const stayUpPenalty = stayUpLateCount * 20;
            const breakPenalty = cancelledBreakCount * 5;
            const overtimePenalty = totalWorkTime > 8 * 60 * 60 ? 20 : 0;
            
            score -= stayUpPenalty;
            score -= breakPenalty;
            score -= overtimePenalty;
            
            const finalScore = Math.max(0, score);
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">åŸºç¡€åˆ†æ•°ï¼š</span>
                    <span class="step-value">100 åˆ†</span>
                </div>
                <div class="process-step">
                    <span class="step-label">ç†¬å¤œæ‰£åˆ†ï¼š</span>
                    <span class="step-value">-${stayUpPenalty} åˆ† (${stayUpLateCount} Ã— 20)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">å–æ¶ˆä¼‘æ¯æ‰£åˆ†ï¼š</span>
                    <span class="step-value">-${breakPenalty} åˆ† (${cancelledBreakCount} Ã— 5)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">è¿‡åŠ³æ‰£åˆ†ï¼š</span>
                    <span class="step-value">-${overtimePenalty} åˆ† ${totalWorkTime > 8 * 60 * 60 ? '(å·¥ä½œè¶…è¿‡8å°æ—¶)' : '(å·¥ä½œæœªè¶…æ—¶)'}</span>
                </div>
                <div class="final-result">
                    æœ€ç»ˆå¾—åˆ†ï¼š${Math.round(finalScore)} åˆ†
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå»ºè®®
        function showRecommendations() {
            console.log('Showing recommendations...');
            const recommendations = generateRecommendations();
            console.log('Generated recommendations:', recommendations);
            
            const container = document.getElementById('recommendationsList');
            if (!container) {
                console.error('Recommendations container not found');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
            container.innerHTML = '';
            
            if (recommendations.length === 0) {
                console.warn('No recommendations generated');
                return;
            }
            
            recommendations.forEach(recommendation => {
                const item = document.createElement('div');
                // æ ¹æ®å»ºè®®ç±»å‹ç›´æ¥åˆ†é…å¯¹åº”çš„é¢œè‰²ç±»
                const typeClassMap = {
                    'work': 'rec-work',
                    'rest': 'rec-rest', 
                    'focus': 'rec-focus',
                    'health': 'rec-health'
                };
                const typeClass = typeClassMap[recommendation.type] || 'rec-health';
                item.className = 'recommendation-item ' + typeClass;
                item.textContent = recommendation.text;
                container.appendChild(item);
            });
            
            console.log('Recommendations displayed successfully');
        }
        
        // ç”Ÿæˆå»ºè®®ï¼ˆå¸¦ç±»å‹ä¿¡æ¯ï¼‰
        function generateRecommendations() {
            const daily = reportData.daily;
            const recommendations = [];
            
            console.log('Generating recommendations for daily data:', daily);
            
            if (!daily) {
                console.warn('No daily data available for recommendations');
                return [
                    { text: 'ğŸ“Š æ¬¢è¿ä½¿ç”¨ç•ªèŒ„é’Ÿå·¥ä½œæŠ¥å‘Šï¼', type: 'health' },
                    { text: 'ğŸ… å¼€å§‹ä½¿ç”¨ç•ªèŒ„é’Ÿæ¥è®°å½•æ‚¨çš„å·¥ä½œæ•°æ®', type: 'work' }
                ];
            }
            
            if (daily.workIntensityScore < 50) {
                recommendations.push({ text: 'ğŸ’ª å»ºè®®å¢åŠ ç•ªèŒ„é’Ÿæ•°é‡ï¼Œæé«˜å·¥ä½œæ•ˆç‡', type: 'work' });
            }
            
            if (daily.restAdequacyScore < 60) {
                recommendations.push({ text: 'â˜• ä¼‘æ¯æ—¶é—´ä¸è¶³ï¼Œå»ºè®®ä¸¥æ ¼æ‰§è¡Œä¼‘æ¯è®¡åˆ’', type: 'rest' });
            }
            
            if (daily.cancelledBreakCount > 2) {
                recommendations.push({ text: 'ğŸ¯ é¢‘ç¹å–æ¶ˆä¼‘æ¯ä¼šå½±å“ä¸“æ³¨åº¦ï¼Œå»ºè®®åšæŒä¼‘æ¯', type: 'focus' });
            }
            
            if (daily.stayUpLateCount > 0) {
                recommendations.push({ text: 'ğŸŒ™ æ£€æµ‹åˆ°ç†¬å¤œè¡Œä¸ºï¼Œå»ºè®®è°ƒæ•´ä½œæ¯æ—¶é—´', type: 'health' });
            }
            
            if (daily.healthScore >= 80) {
                recommendations.push({ text: 'ğŸ‰ ä»Šæ—¥å·¥ä½œçŠ¶æ€è‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼', type: 'health' });
            }
            
            if (daily.focusScore >= 80) {
                recommendations.push({ text: 'ğŸ† ä¸“æ³¨åº¦å¾ˆé«˜ï¼Œå·¥ä½œæ•ˆç‡ä¼˜ç§€ï¼', type: 'focus' });
            }
            
            if (recommendations.length === 0) {
                if (daily.completedPomodoros === 0) {
                    recommendations.push({ text: 'ğŸš€ å¼€å§‹æ‚¨çš„ç¬¬ä¸€ä¸ªç•ªèŒ„é’Ÿï¼Œå»ºç«‹é«˜æ•ˆå·¥ä½œä¹ æƒ¯ï¼', type: 'work' });
                    recommendations.push({ text: 'â° å»ºè®®è®¾ç½®25åˆ†é’Ÿä¸“æ³¨å·¥ä½œï¼Œ5åˆ†é’Ÿä¼‘æ¯çš„èŠ‚å¥', type: 'rest' });
                } else {
                    recommendations.push({ text: 'ğŸ‘ å·¥ä½œçŠ¶æ€æ­£å¸¸ï¼Œç»§ç»­ä¿æŒè‰¯å¥½çš„å·¥ä½œèŠ‚å¥', type: 'health' });
                }
            }
            
            console.log('Generated recommendations:', recommendations);
            return recommendations;
        }
        
        // æŠ˜å /å±•å¼€è¯„åˆ†è®¡ç®—è¯¦æƒ…
        function toggleCalculationDetails() {
            const section = document.getElementById('calculationSection');
            const triggerLink = document.getElementById('calculationTriggerLink');
            const triggerIcon = document.getElementById('calculationTriggerIcon');
            
            if (section.style.display === 'none') {
                // æ˜¾ç¤ºè¯¦æƒ…
                section.style.display = 'block';
                triggerLink.innerHTML = 'ğŸ“Š éšè—è¯„åˆ†è®¡ç®—è¯¦æƒ… <span class="trigger-icon rotated" id="calculationTriggerIcon">â–¼</span>';
                
                // å¹³æ»‘æ»šåŠ¨åˆ°è¯¦æƒ…åŒºåŸŸ
                setTimeout(() => {
                    section.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            } else {
                // éšè—è¯¦æƒ…
                section.style.display = 'none';
                triggerLink.innerHTML = 'ğŸ“Š æŸ¥çœ‹è¯„åˆ†è®¡ç®—è¯¦æƒ… <span class="trigger-icon" id="calculationTriggerIcon">â–¼</span>';
            }
        }
        
        // æ•°æ®æ£€æŸ¥å‡½æ•°
        function checkReportDataStructure() {
            console.log('ğŸ” === REPORT DATA STRUCTURE CHECK ===');
            console.log('ğŸ“Š Full reportData:', reportData);
            
            if (reportData) {
                console.log('âœ… reportData exists');
                console.log('ğŸ“… Daily data keys:', Object.keys(reportData.daily || {}));
                console.log('ğŸ“ˆ Weekly data keys:', Object.keys(reportData.weekly || {}));
                
                if (reportData.weekly && reportData.weekly.heatmapData) {
                    console.log('ğŸ”¥ Heatmap data exists!');
                    console.log('ğŸ“Š Heatmap data length:', reportData.weekly.heatmapData.length);
                    console.log('ğŸ“„ Sample heatmap data:', reportData.weekly.heatmapData.slice(0, 3));
                } else {
                    console.log('âŒ No heatmap data found');
                    console.log('ğŸ”§ Weekly structure:', reportData.weekly);
                }
            } else {
                console.log('âŒ No reportData available');
            }
            console.log('ğŸ” === END DATA STRUCTURE CHECK ===');
        }
        
        // è®¡ç®—æœ¬å‘¨å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹ï¼‰
        function getWeekStartDate(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´ä¸ºå‘¨ä¸€å¼€å§‹
            return new Date(d.setDate(diff));
        }
        
        // è®¡ç®—åº”è¯¥æ˜¾ç¤ºå¤šå°‘å¤©ï¼ˆä»æœ¬å‘¨å¼€å§‹åˆ°ä»Šå¤©ï¼‰
        function getDaysToShow(weekStart, today) {
            const diffTime = today.getTime() - weekStart.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 åŒ…å«ä»Šå¤©
            return Math.min(Math.max(diffDays, 1), 7); // è‡³å°‘æ˜¾ç¤º1å¤©ï¼Œæœ€å¤š7å¤©
        }
        
        // æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ä¸ºåŒä¸€å¤©
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            // å…ˆæ£€æŸ¥æ•°æ®ç»“æ„
            checkReportDataStructure();
            
            // ç„¶ååˆå§‹åŒ–æŠ¥å‘Š
            initializeReport();
        });
        
        // å¦‚æœChart.jsåŠ è½½å¤±è´¥ï¼Œæä¾›å¤‡ç”¨åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('Window loaded');
            if (!reportInitialized) {
                console.log('Report not initialized yet, retrying...');
                setTimeout(initializeReport, 1000);
            }
        });
    </script>
</body>
</html>


