<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日工作报告</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fb;
            color: #1f2937;
            overflow-x: hidden;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Header */
        .report-header { 
            position: relative;
            display: grid;
            grid-template-columns: 320px 1fr; /* 标题与日期上下布局到同一列 */
            grid-template-rows: 1fr auto auto 1fr; /* 通过上下占位行实现整体垂直居中 */
            column-gap: 12px;
            row-gap: 0; /* 更紧凑 */
            align-items: center;
            min-height: 340px;
            padding: 16px 0;
            margin-bottom: 28px; 
            color: #111827; 
            overflow: hidden; /* 防止伪元素溢出压住下方内容 */
        }
        /* 左侧大圆形装饰，使用伪元素，不改动现有 HTML 结构 */
        .report-header::before {
            content: "";
            position: absolute;
            left: 24px;
            top: 20px;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            /* 使用头像作为背景，叠加轻微渐变提升层次 */
            background: radial-gradient(closest-side, rgba(200, 200, 200, 0.08) 0%, rgba(0,0,0,0.18) 100%), url('avatar.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 
                inset 0 0 40px rgba(255,255,255,0.06),
                0 0 14px rgba(0,0,0,0.16),
                0 0 24px rgba(0,0,0,0.10);
            z-index: 0;
            pointer-events: none;
            transition: box-shadow .25s ease, transform .25s ease, filter .25s ease;
        }
        /* 悬停时增强阴影并轻微放大，形成光晕感 */
        .report-header:hover::before {
            box-shadow:
                inset 0 0 44px rgba(255,255,255,0.08),
                0 0 18px rgba(0,0,0,0.20),
                0 0 34px rgba(178,253,0,0.22),
                0 0 64px rgba(178,253,0,0.18);
            transform: scale(1.02);
        }
        /* 额外的光晕层（不改动HTML），在悬停时淡入 */
        .report-header::after {
            content: "";
            position: absolute;
            left: 24px;
            top: 20px;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle,
                rgba(178,253,0,0) 58%,
                rgba(178,253,0,0.28) 78%,
                rgba(178,253,0,0) 98%
            );
            filter: blur(8px);
            opacity: 0;
            transition: opacity .25s ease;
            z-index: 0; /* 始终在文字之下（文字设置了 z-index:1） */
            pointer-events: none;
        }
        .report-header:hover::after {
            opacity: 1;
        }
        .report-header > * { position: relative; z-index: 1; }
        .report-header h1 { 
            grid-column: 2; 
            grid-row: 2; /* 放在中部第二行 */
            font-size: 28px; 
            font-weight: 800; 
            letter-spacing: .2px; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
            text-align: left;
            justify-self: start;
            line-height: 1.1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.12);
        }
        .report-header .report-date { grid-column: 2; grid-row: 3; text-align: left; justify-self: start; margin-top: 6px; align-self: start; white-space: nowrap; font-family: Avenir, -apple-system-font, "PingFangSC-Thin", "Microsoft YaHei", 微软雅黑, sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.12);} 
        /* 今日感受：单独定位到第4行，避免与日期重叠 */
        .report-header #reportMoodLine {
            grid-column: 2;
            grid-row: 4;
            font-size: 14px; 
            text-align: left;
            justify-self: start;
            margin-top: 8px;
            align-self: start;
            color: #6b7280;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        .report-header #reportMoodLine .mood-quote {
            font-size: 20px;
            font-weight: 700;
            color: #374151;
            margin: 0 4px;
            line-height: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.12);
        }
        @media (max-width: 768px) {
            .report-header { grid-template-columns: 1fr; min-height: auto; }
            .report-header::before { width: 220px; height: 220px; left: calc(50% - 110px); top: -20px; opacity: .25; }
            .report-header h1, .report-header .report-date { grid-column: 1; text-align: center; }
        }
        .title-icon { width: 28px; height: 28px; display: inline-block; }
        .report-date { margin-top: 6px; font-size: 13px; color: #6b7280; }

        /* 分享按钮（右上角） */
        .share-button { position: fixed; top: 16px; right: 16px; width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(17,24,39,0.08); cursor: pointer; z-index: 999; transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease; }
        .share-button:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(17,24,39,0.12); background: #ffffff; }
        .share-icon { width: 18px; height: 18px; opacity: .9; transition: transform .2s ease, opacity .2s ease; }
        .share-button:hover .share-icon { transform: scale(1.05); opacity: 1; }

        /* Dashboard wrapper - 无圆角白底样式 */
        .dashboard {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
        }

        /* Metric cards */
        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 16px; 
            margin-bottom: 36px; 
            /* background: #ffffff; 
            border: 1px solid #eef2f7;  */
            border-radius: 16px; 
            /* box-shadow: 0 8px 24px rgba(17,24,39,0.06); */
        }
        .metric-card { background: #f9fafb; border: 1px solid #eef2f7; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 14px; transition: box-shadow .2s ease; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(17,24,39,0.06); min-height: 100px; }
        /* 左侧整高横幅图片 */
        .metric-card { padding-left: 96px; }
        .metric-banner { position: absolute; left: 0; top: 0; bottom: 0; width: 88px; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .metric-card { border-radius: 12px; }
        .metric-banner { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .metric-card:hover { box-shadow: 0 12px 32px rgba(17,24,39,0.10); transform: translateY(-2px); }
        /* 旧的emoji图标已被横幅图片替换 */
        .metric-icon { display: none; }
        .metric-content h3 { font-size: 28px; line-height: 1; font-weight: 800; color: #111827; margin-bottom: 4px; }
        .metric-content p { font-size: 12px; color: #6b7280; letter-spacing: .2px; }
        .banner-pomodoro { background-image: url('banner_pomodoro.png'); }
        .banner-time { background-image: url('banner_time.png'); }
        .banner-relax { background-image: url('banner_relax.png'); }
        .banner-health { background-image: url('banner_health.png'); }
        /* Hover 过渡与横幅微动效 */
        .metric-card { will-change: transform, box-shadow; transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; }
        .metric-banner { transition: transform .25s ease, filter .25s ease; }
        .metric-card:hover .metric-banner { transform: scale(1.03); filter: brightness(1.03); }

        /* Scores */
        .scores-section { margin-bottom: 16px; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); }
        .scores-section h2 { margin-bottom: 12px; color:#111827; font-size:18px; display: inline-flex; align-items: center; gap: 8px; }
        .scores-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; text-align: center; }
        .score-item p { margin-top: 8px; font-weight: 600; color: #6b7280; font-size: 12px; }
        /* Score item hover effects */
        .score-item { background:#ffffff; border:1px solid transparent; border-radius:12px; padding:12px; box-shadow: none; transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; will-change: transform, box-shadow; position: relative; overflow: hidden; }
        .score-item:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(17,24,39,0.10); }
        .score-item canvas { transition: transform .25s ease, filter .25s ease; }
        .score-item:hover canvas { transform: scale(1.03); filter: brightness(1.03); }
        /* 主题化 hover 微光（边框+外发光） */
        .score-item::after { content: ""; position: absolute; inset: 0; pointer-events: none; border-radius: 12px; opacity: 0; transition: opacity .2s ease; }
        .score-item:hover::after { opacity: 1; }
        .score-work:hover { border-color: #ed347c; box-shadow: 0 12px 28px rgba(237,52,124,0.18), 0 6px 14px rgba(17,24,39,0.06); }
        .score-work:hover::after { box-shadow: 0 0 0 2px rgba(237,52,124,0.18) inset; }
        .score-rest:hover { border-color: #b2fd00; box-shadow: 0 12px 28px rgba(178,253,0,0.18), 0 6px 14px rgba(17,24,39,0.06); }
        .score-rest:hover::after { box-shadow: 0 0 0 2px rgba(178,253,0,0.18) inset; }
        .score-focus:hover { border-color: #04f6d1; box-shadow: 0 12px 28px rgba(4,246,209,0.18), 0 6px 14px rgba(17,24,39,0.06); }
        .score-focus:hover::after { box-shadow: 0 0 0 2px rgba(4,246,209,0.18) inset; }
        .score-health:hover { border-color: #cc66ff; box-shadow: 0 12px 28px rgba(204,102,255,0.18), 0 6px 14px rgba(17,24,39,0.06); }
        .score-health:hover::after { box-shadow: 0 0 0 2px rgba(204,102,255,0.18) inset; }

        /* Calculation trigger */
        .calculation-trigger { 
            text-align: center; 
            margin-top: 16px; 
            padding-top: 12px; 
            border-top: 1px solid #eef2f7;
        }
        .calculation-trigger a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: #6b7280;
            font-weight: 400;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
        }
        .calculation-trigger a:hover {
            color: #4b5563;
            background: rgba(0, 0, 0, 0.02);
        }
        .trigger-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .trigger-icon.rotated {
            transform: rotate(180deg);
        }

        /* Calculation cards */
        .calculation-section { margin: 16px 0 24px; }
        .calculation-section h2 { margin-bottom: 12px; font-size: 18px; color:#111827; }
        
        /* Collapsible functionality */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            transition: color 0.2s ease;
        }
        .collapsible-header:hover {
            color: #4f46e5;
        }
        .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            user-select: none;
        }
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        .calculation-grid {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        .calculation-grid.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        .calculation-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .calculation-card { background:#ffffff; border:1px solid #eef2f7; border-radius:10px; padding:12px; box-shadow: 0 4px 12px rgba(17,24,39,0.04); }
        .calculation-card h3 { margin:0 0 8px 0; font-size:13px; color:#111827; }
        .calculation-formula { margin-bottom: 8px; }
        .formula-title { font-weight:600; color:#4b5563; margin-bottom:4px; font-size:11px; }
        .formula-text { background:#f3f4f6; padding:6px 8px; border-radius:6px; font-family: 'Menlo', 'Monaco', monospace; font-size:10px; color:#111827; line-height: 1.3; }
        .process-title { font-weight:600; color:#4b5563; margin-bottom:4px; font-size:11px; }
        .process-steps { background:#fcfcfd; border:1px solid #eef2f7; border-radius:6px; padding:8px; }
        .process-step { margin-bottom:4px; font-size:10px; color:#6b7280; line-height: 1.3; }
        .process-step:last-child { margin-bottom:0; }
        .process-step .step-label { color:#374151; font-weight:500; }
        .process-step .step-value { color:#2563eb; font-weight:700; }
        .final-result { margin-top:8px; padding:6px 8px; background:#10b981; color:#fff; border-radius:6px; font-weight:700; font-size:11px; }

        /* 响应式设计：在小屏幕上调整布局 */
        @media (max-width: 1200px) {
            .calculation-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; }
        }
        @media (max-width: 768px) {
            .calculation-grid { grid-template-columns: 1fr; gap: 16px; }
            .calculation-card { padding: 16px; }
            .calculation-card h3 { font-size: 14px; margin-bottom: 10px; }
            .formula-title, .process-title { font-size: 12px; margin-bottom: 6px; }
            .formula-text { font-size: 11px; padding: 8px 10px; }
            .process-step { font-size: 11px; margin-bottom: 6px; }
            .final-result { font-size: 12px; padding: 8px 10px; margin-top: 10px; }
        }

        /* Details */
        .details-section { margin: 8px 0 24px; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); }
        .details-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; display: inline-flex; align-items: center; gap: 8px; }
        .details-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
        .detail-item { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#ffffff; border:1px solid #eef2f7; border-radius:10px; box-shadow: 0 1px 4px rgba(17,24,39,0.02); transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease; }
        .detail-item:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(17,24,39,0.08); border-color: #e8ecf3; }
        .detail-left { display:flex; align-items:center; gap:8px; }
        .detail-icon { width:22px; text-align:center; font-size:14px; }
        .detail-label { color:#6b7280; font-size:12px; }
        .detail-value { color:#111827; font-weight:800; font-size:16px; }

        /* Trends */
        .trends-section { margin: 8px 0 24px; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); }
        .trends-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; display: inline-flex; align-items: center; gap: 8px; }
        .chart-container { background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:16px; height:350px; position:relative; overflow:hidden; }
        .chart-container canvas { max-height: 300px !important; width:100% !important; height:300px !important; }

        /* Heatmap */
        .heatmap-section { margin: 20px 0; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); }
        .heatmap-section h2 { margin-bottom: 16px; font-size: 20px; color:#111827; display: inline-flex; align-items: center; gap: 8px; }
        .section-icon { width: 18px; height: 18px; display: inline-block; }
        .heatmap-container { background: transparent; border-radius: 12px; padding: 4px; box-shadow: none; }
        .heatmap-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
        .legend-text { font-size: 12px; color: #6b7280; }
        .pomodoro-extreme-color { background: #b91c3c; }     /* 最深红色 - 只有番茄钟，无休息 */
        .pomodoro-high-ratio-color { background: #d12a68; }  /* 深红色 - 番茄钟占主导 */
        .pomodoro-medium-ratio-color { background: #ed347c; } /* 中等红色 - 平衡状态 */
        .pomodoro-low-ratio-color { background: #ff9fb3; }   /* 浅红色 - 休息较多 */
        .break-color { background: #b2fd00; }
        .interruption-color { background: #04f6d1; }
        .cancelled-color { background: #cc66ff; }
        
        .heatmap-grid { 
            display: grid; 
            grid-template-rows: 30px repeat(24, 1fr); 
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 1px; 
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1px;
            min-height: 600px;
        }
        .heatmap-day-label { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            font-size: 11px; 
            font-weight: 600; 
            color: #374151;
            padding: 4px;
        }
        .heatmap-hour-label { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            font-size: 10px; 
            color: #6b7280;
            padding: 2px;
        }
        .heatmap-cell { 
            background: #ffffff; 
            min-height: 20px; 
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .heatmap-cell:hover { 
            transform: scale(1.1); 
            z-index: 10;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .heatmap-cell.has-activity { border-radius: 2px; }
        
        /* Tooltip */
        .heatmap-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }

        /* Recommendations */
        .recommendations-section { margin: 8px 0 24px; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); position: relative; overflow: visible; }
        .recommendations-section h2 { margin-bottom: 12px; font-size:18px; color:#111827; }
        .recommendations-list { display:flex; flex-direction:column; gap:12px; }
         .recommendation-item { padding:14px; border-radius:12px; color:#fff; font-weight:600; letter-spacing:.2px; box-shadow: 0 6px 16px rgba(17,24,39,0.06); }
         /* .recommendation-item::before { content:'💡'; margin-right:8px; } */
         /* Match health ring colors */
         .recommendation-item.rec-work { background: linear-gradient(90deg, rgba(237, 52, 124, 0.85) 0%, rgba(209, 42, 104, 0.85) 100%); }
         .recommendation-item.rec-rest { background: linear-gradient(90deg, rgba(178, 253, 0, 0.85) 0%, rgba(143, 212, 0, 0.85) 100%); }
         .recommendation-item.rec-focus { background: linear-gradient(90deg, rgba(4, 246, 209, 0.85) 0%, rgba(3, 201, 168, 0.85) 100%); }
         .recommendation-item.rec-health { background: linear-gradient(90deg, rgba(204, 102, 255, 0.85) 0%, rgba(184, 77, 255, 0.85) 100%); }

        /* Reflections */
        .reflection-section { margin-top: 18px; background:#ffffff; border:1px solid #eef2f7; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(17,24,39,0.06); }
        .reflection-title { font-size: 18px; color:#111827; margin-bottom: 12px; }
        .reflection-grid { display: grid; grid-template-columns: 1fr 280px; gap: 16px; }
        .reflection-input { background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:12px; min-height: 120px; resize: vertical; width:100%; font-size: 13px; color:#111827; }
        .mood-row { display:flex; align-items:center; justify-content:space-between; background:#ffffff; border:1px solid #eef2f7; border-radius:12px; padding:12px 14px; height:120px; }
        .mood-row .mood { font-size: 28px; cursor: default; filter: grayscale(0.05); transition: transform .12s ease; }
        .mood-row .mood:hover { transform: translateY(-2px) scale(1.05); }
        .mood-row .mood.selected { transform: scale(1.1); filter: none; opacity: 1; }
        .mood-row .mood.disabled { filter: grayscale(1); opacity: 0.35; }
        .mood-row .mood.disabled:hover { filter: none; opacity: 1; }
        .mood-info { grid-column: 1 / -1; margin-top: 8px; font-size: 12px; color:#6b7280; }
        .mood-info .label { color:#374151; font-weight:600; margin-right: 6px; }
        .mood-info .value { color:#111827; font-weight:700; margin-right: 10px; }
        .mood-info .time { color:#9ca3af; margin-left: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <button class="share-button" id="reportShareButton" title="分享">
            <img class="share-icon" src="share.svg" alt="分享" />
        </button>
        <header class="report-header">
            <h1>
                今日工作报告
            </h1>
            <p class="report-date" id="reportDate"></p>
            <p class="report-date" id="reportMoodLine"></p>
        </header>
        
        
        
        <div class="dashboard">
            <!-- 健康建议 -->
            <div class="recommendations-section">
                <h2>
                    <img src="idea.svg" alt="健康建议" class="section-icon" />
                    健康建议
                </h2>
                <div id="recommendationsList" class="recommendations-list">
                </div>
            </div>
            <!-- 核心指标卡片 -->
            <div class="metrics-grid">
                <div class="metric-card pomodoro-card">
                    <div class="metric-banner banner-pomodoro"></div>
                    <div class="metric-content">
                        <h3 id="pomodoroCount">0</h3>
                        <p>完成番茄钟</p>
                    </div>
                </div>
                
                <div class="metric-card work-time-card">
                    <div class="metric-banner banner-time"></div>
                    <div class="metric-content">
                        <h3 id="workTime">0h 0m</h3>
                        <p>工作时间</p>
                    </div>
                </div>
                
                <div class="metric-card break-time-card">
                    <div class="metric-banner banner-relax"></div>
                    <div class="metric-content">
                        <h3 id="breakTime">0m</h3>
                        <p>休息时间</p>
                    </div>
                </div>
                
                <div class="metric-card health-card">
                    <div class="metric-banner banner-health"></div>
                    <div class="metric-content">
                        <h3 id="healthScore">0</h3>
                        <p>健康评分</p>
                    </div>
                </div>
            </div>
            
            <!-- 评分仪表盘 -->
            <div class="scores-section">
                <h2>
                    <img src="speedometer.svg" alt="综合评估" class="section-icon" />
                    综合评估
                </h2>
                <div class="scores-grid">
                    <div class="score-item score-work">
                        <canvas id="workIntensityChart" width="120" height="120"></canvas>
                        <p>工作强度</p>
                    </div>
                    <div class="score-item score-rest">
                        <canvas id="restAdequacyChart" width="120" height="120"></canvas>
                        <p>休息充足度</p>
                    </div>
                    <div class="score-item score-focus">
                        <canvas id="focusChart" width="120" height="120"></canvas>
                        <p>专注度</p>
                    </div>
                    <div class="score-item score-health">
                        <canvas id="healthChart" width="120" height="120"></canvas>
                        <p>健康度</p>
                    </div>
                </div>
                
                <!-- 评分计算详情触发链接 -->
                <div class="calculation-trigger">
                    <a href="#" onclick="toggleCalculationDetails(); return false;" id="calculationTriggerLink">
                        查看评分计算详情
                        <span class="trigger-icon" id="calculationTriggerIcon">▼</span>
                    </a>
                </div>
            </div>
            
            <!-- 计算过程详情 -->
            <div class="calculation-section" id="calculationSection" style="display: none;">
                <h2>
                    <img src="caculator.svg" alt="综合评估" class="section-icon" />
                    评分计算详情
                </h2>
                <div class="calculation-grid" id="calculationGrid">
                    <div class="calculation-card">
                        <h3>🌙 休息充足度</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">计算公式：</div>
                            <div class="formula-text">休息充足度 = min(实际休息时间 / 期望休息时间, 1.0) × 100</div>
                        </div>
                        <div class="calculation-process" id="restCalculationProcess">
                            <div class="process-title">计算过程：</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>💪 工作强度</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">计算公式：</div>
                            <div class="formula-text">工作强度 = 番茄钟评分(50) + 休息平衡评分(30) + 一致性评分(20)</div>
                        </div>
                        <div class="calculation-process" id="workCalculationProcess">
                            <div class="process-title">计算过程：</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>🎯 专注度</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">计算公式：</div>
                            <div class="formula-text">专注度 = max(0, min(100, 基础得分 - 中断惩罚))</div>
                        </div>
                        <div class="calculation-process" id="focusCalculationProcess">
                            <div class="process-title">计算过程：</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                    
                    <div class="calculation-card">
                        <h3>🩺 健康度</h3>
                        <div class="calculation-formula">
                            <div class="formula-title">计算公式：</div>
                            <div class="formula-text">健康度 = max(0, 100 - 熬夜扣分 - 休息扣分 - 过劳扣分)</div>
                        </div>
                        <div class="calculation-process" id="healthCalculationProcess">
                            <div class="process-title">计算过程：</div>
                            <div class="process-steps"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 详细统计 -->
            <div class="details-section">
                <h2>
                    <img src="pie-chart.svg" alt="详细统计" class="section-icon" />
                    详细统计
                </h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">🟢</span>
                            <span class="detail-label">短休息次数</span>
                        </div>
                        <span class="detail-value" id="shortBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">⏳</span>
                            <span class="detail-label">长休息次数</span>
                        </div>
                        <span class="detail-value" id="longBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">❌</span>
                            <span class="detail-label">取消休息次数</span>
                        </div>
                        <span class="detail-value" id="cancelledBreakCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">🔒</span>
                            <span class="detail-label">息屏次数</span>
                        </div>
                        <span class="detail-value" id="screenLockCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">🖥️</span>
                            <span class="detail-label">屏保次数</span>
                        </div>
                        <span class="detail-value" id="screensaverCount">0</span>
                    </div>
                    <div class="detail-item">
                        <div class="detail-left">
                            <span class="detail-icon" aria-hidden="true">🔥</span>
                            <span class="detail-label">熬夜次数</span>
                        </div>
                        <span class="detail-value" id="stayUpLateCount">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 周趋势图表 -->
            <div class="trends-section">
                <h2>
                    <img src="diagram.svg" alt="一周趋势" class="section-icon" />
                    一周趋势
                </h2>
                <div class="chart-container">
                    <canvas id="weeklyTrendChart" width="800" height="300"></canvas>
                </div>
            </div>
            
            <!-- 活动热力图 -->
            <div class="heatmap-section">
                <h2>
                    <img src="bar-chart.svg" alt="活动热力图" class="section-icon" />
                    活动热力图
                </h2>
                <div class="heatmap-container">
                    <div class="heatmap-legend">
                        <div class="legend-item">
                            <span class="legend-color pomodoro-extreme-color"></span>
                            <span class="legend-text">纯番茄钟</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-high-ratio-color"></span>
                            <span class="legend-text">番茄钟(主导)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-medium-ratio-color"></span>
                            <span class="legend-text">番茄钟(平衡)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color pomodoro-low-ratio-color"></span>
                            <span class="legend-text">番茄钟(休息多)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color break-color"></span>
                            <span class="legend-text">纯休息</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color interruption-color"></span>
                            <span class="legend-text">中断</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color cancelled-color"></span>
                            <span class="legend-text">取消休息</span>
                        </div>
                    </div>
                    <div class="heatmap-grid" id="heatmapGrid">
                        <!-- 热力图内容将由JavaScript生成 -->
                    </div>
                </div>
            </div>
            
            

            <!-- 你的感受（移至底部） -->
            <div class="reflection-section">
                <h2 class="reflection-title">
                    <img src="smile.svg" alt="你的感受" class="section-icon" />
                    你的感受
                </h2>
                <div class="reflection-grid">
                    <textarea id="moodNoteInput" class="reflection-input" placeholder="记录今天的想法与感受..."></textarea>
                    <div class="mood-row" id="moodRow">
                        <span class="mood" data-level="1">😞</span>
                        <span class="mood" data-level="2">😐</span>
                        <span class="mood" data-level="3">🙂</span>
                        <span class="mood" data-level="4">😊</span>
                        <span class="mood" data-level="5">😄</span>
                        <span class="mood" data-level="6">🤩</span>
                    </div>
                    <div class="mood-info" id="moodInfo" aria-live="polite"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 防止重复初始化的标志
        var reportInitialized = false;
        
        // 初始化报告
        function initializeReport() {
            if (reportInitialized) {
                console.log('Report already initialized, skipping...');
                return;
            }
            
            // 检查Chart.js是否加载
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded, retrying in 500ms...');
                setTimeout(initializeReport, 500);
                return;
            }
            
            try {
                console.log('Starting report initialization...');
                console.log('Chart.js version:', Chart.version);
                console.log('Report data:', reportData);
                
                updateBasicMetrics();
                createScoreCharts();
                showCalculationDetails();
                createWeeklyTrendChart();
                createActivityHeatmap();
                showRecommendations();
                setupMoodInteractions();
                renderMoodInfoFromDaily();
                try { triggerConfettiIfHealthy(); } catch(e) { console.warn('confetti init failed', e); }
                reportInitialized = true;
                console.log('Report initialized successfully');
            } catch (error) {
                console.error('Error initializing report:', error);
                console.error('Stack trace:', error.stack);
            }
        }

        // 你的感受交互
        function setupMoodInteractions() {
            const moodRow = document.getElementById('moodRow');
            const noteInput = document.getElementById('moodNoteInput');
            const moodInfo = document.getElementById('moodInfo');

            // 预填今日已有的心情数据
            try {
                const daily = reportData.daily || {};
                if (daily.moodLevel) {
                    const selectedEl = moodRow.querySelector(`[data-level="${daily.moodLevel}"]`);
                    if (selectedEl) {
                        moodRow.querySelectorAll('.mood').forEach(el => el.classList.remove('selected', 'disabled'));
                        selectedEl.classList.add('selected');
                        moodRow.querySelectorAll('.mood').forEach(el => { if (el !== selectedEl) el.classList.add('disabled'); });
                    }
                } else {
                    // 无预设选择时，确保都非灰
                    moodRow.querySelectorAll('.mood').forEach(el => el.classList.remove('selected', 'disabled'));
                }
                if (daily.moodNote) {
                    noteInput.value = daily.moodNote;
                }
                updateMoodInfo(daily.moodLevel || null, daily.moodNote || '', daily.moodUpdatedAt || null);
            } catch (e) { console.warn('Prefill mood failed', e); }

            // 点击心情等级
            moodRow.addEventListener('click', (e) => {
                const target = e.target.closest('.mood');
                if (!target) return;
                const level = parseInt(target.getAttribute('data-level'));
                // 视觉反馈
                moodRow.querySelectorAll('.mood').forEach(el => el.classList.remove('selected', 'disabled'));
                target.classList.add('selected');
                moodRow.querySelectorAll('.mood').forEach(el => { if (el !== target) el.classList.add('disabled'); });
                // 保存
                const note = noteInput.value || '';
                if (typeof saveMoodToNative === 'function') {
                    saveMoodToNative(level, note);
                }
                console.log('Saved mood level:', level, 'note:', note);
                updateMoodInfo(level, note, new Date().toISOString());
            });

            // 文本输入失焦时保存
            noteInput.addEventListener('change', () => {
                const selected = moodRow.querySelector('.mood.selected');
                const level = selected ? parseInt(selected.getAttribute('data-level')) : null;
                const note = noteInput.value || '';
                if (level !== null || note.length > 0) {
                    if (typeof saveMoodToNative === 'function') {
                        saveMoodToNative(level, note);
                    }
                    console.log('Saved mood note:', note, 'level:', level);
                    updateMoodInfo(level, note, new Date().toISOString());
                }
            });
        }

        function renderMoodInfoFromDaily() {
            const daily = reportData.daily || {};
            updateMoodInfo(daily.moodLevel || null, daily.moodNote || '', daily.moodUpdatedAt || null);
        }

        function updateMoodInfo(level, note, updatedAtISO) {
            const moodInfo = document.getElementById('moodInfo');
            if (!moodInfo) return;
            const emojiMap = {
                1: '😞', 2: '😐', 3: '🙂', 4: '😊', 5: '😄', 6: '🤩'
            };
            const levelText = level ? `${emojiMap[level] || ''} 级别 ${level}` : '未选择';
            const noteText = note && note.trim().length > 0 ? note.trim() : '（无记录）';
            let timeText = '';
            try {
                if (updatedAtISO && updatedAtISO !== null) {
                    const d = new Date(updatedAtISO);
                    if (!isNaN(d.getTime())) {
                        timeText = `· 更新于 ${d.toLocaleString('zh-CN')}`;
                    }
                }
            } catch {}
            moodInfo.innerHTML = `<span class="label">今天的感受：</span><span class="value">${levelText}</span><span class="label">备注：</span><span class="value">${escapeHTML(noteText)}</span><span class="time">${timeText}</span>`;
        }

        function escapeHTML(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // 更新基本指标
        function updateBasicMetrics() {
            const daily = reportData.daily;
            
            // 更新日期
            document.getElementById('reportDate').textContent = 
                new Date(daily.date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            // 在日期下方显示“今日感受”
            const moodLineEl = document.getElementById('reportMoodLine');
            if (moodLineEl) {
                const emojiMap = { 1:'😞',2:'😐',3:'🙂',4:'😊',5:'😄',6:'🤩' };
                const level = daily.moodLevel || null;
                const emoji = level ? (emojiMap[level] || '') : '';
                const rawNote = (daily.moodNote && String(daily.moodNote).trim().length > 0) ? String(daily.moodNote).trim() : '';
                const note = rawNote ? escapeHTML(rawNote) : '';
                let inner = '';
                if (level) {
                    inner += `${emoji} `;
                }
                if (note) {
                    inner += (inner ? ' ' : '') + note;
                }
                if (!level && !note) {
                    inner += '未记录';
                }
                moodLineEl.innerHTML = `<span class="mood-quote">“</span>${inner}<span class="mood-quote">”</span>`;
            }
            
            // 更新核心指标
            document.getElementById('pomodoroCount').textContent = daily.completedPomodoros;
            
            const workHours = Math.floor(daily.totalWorkTime / 3600);
            const workMinutes = Math.floor((daily.totalWorkTime % 3600) / 60);
            document.getElementById('workTime').textContent = workHours + 'h ' + workMinutes + 'm';
            
            const breakMinutes = Math.floor(daily.totalBreakTime / 60);
            document.getElementById('breakTime').textContent = breakMinutes + 'm';
            
            document.getElementById('healthScore').textContent = Math.round(daily.healthScore);
            
            // 更新详细统计
            document.getElementById('shortBreakCount').textContent = daily.shortBreakCount;
            document.getElementById('longBreakCount').textContent = daily.longBreakCount;
            document.getElementById('cancelledBreakCount').textContent = daily.cancelledBreakCount;
            document.getElementById('screenLockCount').textContent = daily.screenLockCount;
            document.getElementById('screensaverCount').textContent = daily.screensaverCount;
            document.getElementById('stayUpLateCount').textContent = daily.stayUpLateCount;
        }
        
        // 创建评分圆环图
        function createScoreCharts() {
            const daily = reportData.daily;
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, using fallback display');
                createFallbackScoreDisplay();
                return;
            }
            
            createDoughnutChart('workIntensityChart', daily.workIntensityScore, '工作强度', '#ed347c');
            createDoughnutChart('restAdequacyChart', daily.restAdequacyScore, '休息充足度', '#b2fd00');
            createDoughnutChart('focusChart', daily.focusScore, '专注度', '#04f6d1');
            createDoughnutChart('healthChart', daily.healthScore, '健康度', '#cc66ff');
        }
        
        // Chart.js不可用时的备用显示
        function createFallbackScoreDisplay() {
            const daily = reportData.daily;
            const scores = [
                { id: 'workIntensityChart', score: daily.workIntensityScore, label: '工作强度' },
                { id: 'restAdequacyChart', score: daily.restAdequacyScore, label: '休息充足度' },
                { id: 'focusChart', score: daily.focusScore, label: '专注度' },
                { id: 'healthChart', score: daily.healthScore, label: '健康度' }
            ];
            
            scores.forEach(item => {
                const canvas = document.getElementById(item.id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    // 简单的文本显示
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#333';
                    ctx.fillText(Math.round(item.score), canvas.width/2, canvas.height/2);
                }
            });
        }
        
        function createDoughnutChart(canvasId, score, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // 销毁已存在的图表
            if (window[canvasId + '_chart'] && typeof window[canvasId + '_chart'].destroy === 'function') {
                window[canvasId + '_chart'].destroy();
            }
            
            window[canvasId + '_chart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [color, '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    elements: {
                        arc: {
                            borderWidth: 0
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [{
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillStyle = color;
                        ctx.fillText(Math.round(score), centerX, centerY);
                        ctx.restore();
                    }
                }]
            });
        }
        
        // 创建周趋势图
        function createWeeklyTrendChart() {
            console.log('Creating weekly trend chart...');
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, showing fallback message');
                const canvas = document.getElementById('weeklyTrendChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#666';
                    ctx.fillText('图表加载中...', canvas.width/2, canvas.height/2);
                }
                return;
            }
            
            const weekly = reportData.weekly;
            console.log('Weekly data:', weekly);
            
            if (!weekly || !weekly.dailyTrend || weekly.dailyTrend.length === 0) {
                console.warn('No weekly trend data available, showing empty chart');
                // 显示空图表，不使用模拟数据
                const emptyWeekly = {
                    dailyTrend: []
                };
                createWeeklyTrendChartWithData(emptyWeekly);
                return;
            }
            
            createWeeklyTrendChartWithData(weekly);
        }
        
        function createWeeklyTrendChartWithData(weekly) {
            const canvas = document.getElementById('weeklyTrendChart');
            // 让图表自身按容器宽度自适应
            canvas.removeAttribute('width');
            canvas.removeAttribute('height');
            canvas.style.width = '100%';
            canvas.style.height = 'auto';
            const ctx = canvas.getContext('2d');
            
            // 销毁已存在的图表
            if (window.weeklyTrendChart && typeof window.weeklyTrendChart.destroy === 'function') {
                window.weeklyTrendChart.destroy();
            }
            
            // 使用后端提供的实际日期数据生成标签
            const labels = weekly.dailyTrend.length > 0 
                ? weekly.dailyTrend.map((day, index) => {
                    const date = new Date(day.date);
                    const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                    // 检查是否是最后一天（今天）
                    const isToday = index === weekly.dailyTrend.length - 1;
                    return isToday ? `${weekdayLabel}\n(今天)` : weekdayLabel;
                })
                : Array.from({ length: 7 }, (_, index) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (6 - index)); // 过去7天（包括今天）
                    const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                    // 最后一个索引是今天
                    const isToday = index === 6;
                    return isToday ? `${weekdayLabel}\n(今天)` : weekdayLabel;
                });
            console.log('Chart labels:', labels);
            
            window.weeklyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '番茄钟数量',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.pomodoros || 0)
                                : Array(7).fill(0),
                            borderColor: '#ed347c',
                            backgroundColor: 'rgba(237, 52, 124, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '休息次数',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.breakCount || 0)
                                : Array(7).fill(0),
                            borderColor: '#b2fd00',
                            backgroundColor: 'rgba(178, 253, 0, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '健康度',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => day.healthScore || 0)
                                : Array(7).fill(0),
                            borderColor: '#cc66ff',
                            backgroundColor: 'rgba(204, 102, 255, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: '心情指数',
                            data: weekly.dailyTrend.length > 0 
                                ? weekly.dailyTrend.map(day => (day.moodIndex !== undefined && day.moodIndex !== null) ? day.moodIndex : null)
                                : Array(7).fill(null),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [6, 4],
                            tension: 0.4,
                            spanGaps: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    // 关键设置：由图表自身控制尺寸，随容器宽度变化
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.6, // 宽高比，避免被拉伸（约等于 800/308）
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '数量'
                            },
                            min: 0
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '健康度评分'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '本周工作趋势'
                        }
                    }
                }
            });
        }
        
        // 创建活动热力图（纵向布局）
        function createActivityHeatmap() {
            console.log('Creating activity heatmap...');
            
            const heatmapGrid = document.getElementById('heatmapGrid');
            if (!heatmapGrid) {
                console.warn('Heatmap grid element not found');
                return;
            }
            
            // 获取热力图数据（从数据库或模拟数据）
            const weekData = getHeatmapDataFromDB();
            
            // 清空现有内容
            heatmapGrid.innerHTML = '';
            
            // 计算今天和过去7天开始日期，用于数据判断（与一周趋势图表保持一致）
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - 6); // 过去7天（包括今天）
            
            console.log('📅 Today:', today.toDateString());
            console.log('📅 Week start:', weekStart.toDateString());
            console.log('📅 Days to show: 7 (full week)');
            
            // 根据实际日期生成标签（过去7天）
            const dayLabels = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const weekdayLabel = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                dayLabels.push(weekdayLabel);
            }
            console.log('📅 Heatmap day labels:', dayLabels);
            const daysToShow = 7; // 固定显示7天
            
            // CSS Grid模板固定为7天
            heatmapGrid.style.gridTemplateColumns = `40px repeat(7, 1fr)`;
            
            // 创建表头 - 左上角空格 + 日期标签
            heatmapGrid.appendChild(createEmptyCell()); // 左上角空格
            dayLabels.forEach((dayLabel, dayIndex) => {
                const dayCell = document.createElement('div');
                dayCell.className = 'heatmap-day-label';
                
                // 计算具体日期
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + dayIndex);
                const dateStr = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                
                dayCell.textContent = `${dayLabel}\n${dateStr}`;
                dayCell.style.whiteSpace = 'pre-line';
                dayCell.style.textAlign = 'center';
                dayCell.style.fontSize = '12px';
                dayCell.style.lineHeight = '1.2';
                
                // 如果是今天，添加特殊标识
                if (isSameDay(currentDate, today)) {
                    dayCell.style.fontWeight = 'bold';
                    dayCell.style.color = '#007AFF';
                    dayCell.title = '今天';
                }
                
                heatmapGrid.appendChild(dayCell);
            });
            
            // 创建24小时的数据行
            for (let hour = 0; hour < 24; hour++) {
                // 时间标签（左侧）
                const hourCell = document.createElement('div');
                hourCell.className = 'heatmap-hour-label';
                hourCell.textContent = hour.toString().padStart(2, '0') + ':00';
                heatmapGrid.appendChild(hourCell);
                
                // 每一天的数据（显示完整一周，包括未来日期）
                for (let dayIndex = 0; dayIndex < daysToShow; dayIndex++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    // 计算当前日期
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + dayIndex);
                    
                    // 判断是否为未来日期
                    const isFutureDate = currentDate > today;
                    
                    // 获取数据（如果是未来日期或没有数据，则为空）
                    const dayData = weekData[dayIndex];
                    const hourData = dayData && dayData[hour] && !isFutureDate ? dayData[hour] : {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // 只有当不是未来日期且有活动时才显示数据
                    if (!isFutureDate && hourData.hasActivity) {
                        cell.classList.add('has-activity');
                        const color = getActivityColor(hourData.primaryActivity, hourData);
                        cell.style.backgroundColor = color;
                        // 根据活动强度调整透明度
                        const intensity = Math.min(hourData.totalActivities / 5, 1); // 最大5个活动为满强度
                        const opacity = 0.3 + (intensity * 0.7); // 0.3-1.0的透明度范围
                        cell.style.opacity = opacity;
                    }
                    
                    // 为未来日期添加特殊样式（可选）
                    if (isFutureDate) {
                        cell.style.opacity = '0.3';
                        cell.style.backgroundColor = '#f8f9fa';
                    }
                    
                    // 添加鼠标悬停效果和工具提示
                    const currentDayLabel = dayLabels[dayIndex];
                    cell.addEventListener('mouseenter', (e) => showHeatmapTooltip(e, currentDayLabel, hour, hourData, isFutureDate));
                    cell.addEventListener('mouseleave', hideHeatmapTooltip);
                    
                    heatmapGrid.appendChild(cell);
                }
            }
            
            console.log('Activity heatmap created successfully');
        }
        
        // 创建空白单元格
        function createEmptyCell() {
            const cell = document.createElement('div');
            cell.className = 'heatmap-day-label';
            cell.style.background = 'transparent';
            return cell;
        }
        
        // 从数据库获取热力图数据
        function getHeatmapDataFromDB() {
            console.log('🔍 Fetching heatmap data from database...');
            console.log('📊 reportData:', reportData);
            
            // 尝试从reportData中获取热力图数据
            if (reportData && reportData.weekly && reportData.weekly.heatmapData) {
                console.log('✅ Using real heatmap data from database');
                console.log('📅 Raw heatmap data length:', reportData.weekly.heatmapData.length);
                return processHeatmapData(reportData.weekly.heatmapData);
            }
            
            // 如果没有真实数据，使用模拟数据
            console.log('⚠️ No real heatmap data available, using simulated data');
            console.log('🔧 reportData structure check:');
            console.log('  - reportData exists:', !!reportData);
            console.log('  - reportData.weekly exists:', !!(reportData && reportData.weekly));
            console.log('  - reportData.weekly.heatmapData exists:', !!(reportData && reportData.weekly && reportData.weekly.heatmapData));
            return generateSimulatedHeatmapData();
        }
        
        // 处理从数据库获取的热力图数据（按天统计格式）
        function processHeatmapData(rawData) {
            console.log('🔄 Processing heatmap data, total daily records:', rawData.length);
            console.log('📋 Sample daily record:', rawData[0]);
            
            const weekData = [];
            let totalProcessedActivities = 0;
            
            // 初始化7天x24小时的数据结构
            for (let day = 0; day < 7; day++) {
                const dayData = [];
                
                // 查找对应天的数据记录
                const dayRecord = rawData.find(record => record.dayOffset === day);
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // 如果找到该天的记录，查找该小时的活动
                    if (dayRecord && dayRecord.activities && dayRecord.activities[`hour_${hour}`]) {
                        const hourActivity = dayRecord.activities[`hour_${hour}`];
                        
                        hourData.hasActivity = true;
                        hourData.primaryActivity = hourActivity.primaryActivity;
                        hourData.totalActivities = hourActivity.totalActivities;
                        
                        // 转换activities格式
                        Object.entries(hourActivity.activities).forEach(([type, count]) => {
                            hourData.activities.push({ type, count });
                        });
                        
                        totalProcessedActivities += hourActivity.totalActivities;
                    }
                    
                    dayData.push(hourData);
                }
                weekData.push(dayData);
            }
            
            console.log(`✅ Processed ${totalProcessedActivities} activities total from daily records`);
            return weekData;
        }
        
        // 生成模拟热力图数据（当数据库数据不可用时）
        function generateSimulatedHeatmapData() {
            console.log('🎭 Generating simulated heatmap data...');
            const weekData = [];
            let simulatedActivities = 0;
            
            for (let day = 0; day < 7; day++) {
                const dayData = [];
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = {
                        hasActivity: false,
                        primaryActivity: null,
                        activities: [],
                        totalActivities: 0
                    };
                    
                    // 模拟工作时间的活动数据
                    if (hour >= 9 && hour <= 18 && day < 5) { // 工作日9-18点
                        const rand = Math.random();
                        if (rand > 0.3) { // 70%概率有活动
                            hourData.hasActivity = true;
                            const activityCount = Math.floor(Math.random() * 3) + 1;
                            hourData.totalActivities = activityCount;
                            simulatedActivities += activityCount;
                            
                            if (rand > 0.8) {
                                hourData.primaryActivity = 'interruption';
                                hourData.activities.push({ type: 'interruption', count: activityCount });
                            } else if (rand > 0.6) {
                                hourData.primaryActivity = 'cancelled';
                                hourData.activities.push({ type: 'cancelled', count: activityCount });
                            } else if (rand > 0.4) {
                                hourData.primaryActivity = 'break';
                                hourData.activities.push({ type: 'break', count: activityCount });
                            } else {
                                hourData.primaryActivity = 'pomodoro';
                                hourData.activities.push({ type: 'pomodoro', count: activityCount });
                            }
                            
                            // console.log(`🎯 Simulated activity: ${hourData.primaryActivity} on day ${day}, hour ${hour}`);
                        }
                    }
                    
                    dayData.push(hourData);
                }
                weekData.push(dayData);
            }
            
            console.log(`🎭 Generated ${simulatedActivities} simulated activities total`);
            return weekData;
        }
        
        // 根据活动数据获取颜色（优先使用数据驱动，避免 primaryActivity 误判导致颜色不符）
        function getActivityColor(activityType, hourData = null) {
            if (hourData && Array.isArray(hourData.activities)) {
                let pomodoroCount = 0;
                let breakCount = 0;
                let cancelledCount = 0;
                let interruptionCount = 0;
                hourData.activities.forEach(activity => {
                    if (activity.type === 'pomodoro') pomodoroCount += activity.count;
                    else if (activity.type === 'break') breakCount += activity.count;
                    else if (activity.type === 'cancelled') cancelledCount += activity.count;
                    else if (activity.type === 'interruption') interruptionCount += activity.count;
                });

                // 规则：
                // 1) 若存在番茄钟：按 番茄钟/休息 比例映射红色深浅（不考虑中断与取消，以免误判）
                if (pomodoroCount > 0) {
                    const totalForRatio = pomodoroCount + breakCount;
                    if (totalForRatio > 0) {
                        const pomodoroRatio = pomodoroCount / totalForRatio;
                        if (pomodoroRatio === 1.0) return '#b91c3c';      // 纯番茄钟
                        if (pomodoroRatio >= 0.8) return '#d12a68';        // 番茄主导
                        if (pomodoroRatio >= 0.5) return '#ed347c';        // 平衡
                        return '#ff9fb3';                                   // 休息较多
                    }
                    // 有番茄钟但计算不到休息比例时，使用默认红
                    return '#ed347c';
                }

                // 2) 无番茄钟且有休息：绿色
                if (breakCount > 0) return '#b2fd00';

                // 3) 仅取消休息：紫色；仅中断：青色
                if (cancelledCount > 0 && interruptionCount === 0) return '#cc66ff';
                if (interruptionCount > 0 && cancelledCount === 0) return '#04f6d1';

                // 4) 其他混合情况，回退到 primaryActivity 基色
            }

            // 回退：按主类型取基色
            const fallback = {
                'pomodoro': '#ed347c',
                'break': '#b2fd00',
                'interruption': '#04f6d1',
                'cancelled': '#cc66ff'
            };
            return fallback[activityType] || '#ffffff';
        }
        
        // 显示工具提示
        function showHeatmapTooltip(event, dayLabel, hour, hourData, isFutureDate = false) {
            const tooltip = document.createElement('div');
            tooltip.className = 'heatmap-tooltip';
            
            let content = `${dayLabel} ${hour.toString().padStart(2, '0')}:00`;
            
            if (isFutureDate) {
                content += `<br>未来时间`;
            } else if (hourData.hasActivity) {
                content += `<br>`;
                
                // 计算番茄钟和休息的数量用于显示比例
                let pomodoroCount = 0;
                let breakCount = 0;
                let cancelledCount = 0;
                
                hourData.activities.forEach(activity => {
                    const activityNames = {
                        'pomodoro': '番茄钟',
                        'break': '休息',
                        'interruption': '中断',
                        'cancelled': '取消休息'
                    };
                    content += `${activityNames[activity.type]}: ${activity.count}次<br>`;
                    
                    // 统计番茄钟和休息数量
                    if (activity.type === 'pomodoro') {
                        pomodoroCount += activity.count;
                    } else if (activity.type === 'break') {
                        breakCount += activity.count;
                    } else if (activity.type === 'cancelled') {
                        cancelledCount += activity.count;
                    }
                });
                
                // 如果有番茄钟，显示比例或强度信息
                if (pomodoroCount > 0) {
                    if (breakCount > 0) {
                        // 有番茄钟和休息，显示比例
                        const totalCount = pomodoroCount + breakCount;
                        const pomodoroRatio = (pomodoroCount / totalCount * 100).toFixed(0);
                        content += `<br>番茄钟比例: ${pomodoroRatio}%`;
                    } else if (cancelledCount > 0) {
                        // 有番茄钟，但休息全部被取消
                        content += `<br>⚠️ 未实际休息（取消休息 ${cancelledCount} 次）`;
                    } else {
                        // 只有番茄钟，无任何休息记录
                        content += `<br>⚠️ 高强度工作，无休息`;
                    }
                }
            } else {
                content += `<br>无活动`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            
            document.body.appendChild(tooltip);
        }
        
        // 隐藏工具提示
        function hideHeatmapTooltip() {
            const tooltips = document.querySelectorAll('.heatmap-tooltip');
            tooltips.forEach(tooltip => tooltip.remove());
        }
        
        // 显示计算详情
        function showCalculationDetails() {
            console.log('Showing calculation details...');
            const daily = reportData.daily;
            
            if (!daily) {
                console.warn('No daily data available for calculation details');
                return;
            }
            
            // 显示休息充足度计算过程
            showRestCalculation(daily);
            
            // 显示工作强度计算过程
            showWorkIntensityCalculation(daily);
            
            // 显示专注度计算过程
            showFocusCalculation(daily);
            
            // 显示健康度计算过程
            showHealthCalculation(daily);
        }
        
        // 休息充足度计算过程
        function showRestCalculation(daily) {
            const container = document.querySelector('#restCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalBreakTime = daily.totalBreakTime || 0;
            const expectedBreakTime = completedPomodoros * 5 * 60; // 5分钟 * 60秒
            const actualBreakRatio = expectedBreakTime > 0 ? totalBreakTime / expectedBreakTime : 0;
            const finalScore = Math.min(actualBreakRatio, 1.0) * 100;
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">完成番茄钟数：</span>
                    <span class="step-value">${completedPomodoros} 个</span>
                </div>
                <div class="process-step">
                    <span class="step-label">实际休息时间：</span>
                    <span class="step-value">${Math.round(totalBreakTime / 60)} 分钟</span>
                </div>
                <div class="process-step">
                    <span class="step-label">期望休息时间：</span>
                    <span class="step-value">${Math.round(expectedBreakTime / 60)} 分钟 (${completedPomodoros} × 5分钟)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">休息时间比例：</span>
                    <span class="step-value">${(actualBreakRatio * 100).toFixed(1)}%</span>
                </div>
                <div class="final-result">
                    最终得分：${Math.round(finalScore)} 分
                </div>
            `;
        }
        
        // 工作强度计算过程
        function showWorkIntensityCalculation(daily) {
            const container = document.querySelector('#workCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalWorkTime = daily.totalWorkTime || 0;
            const totalBreakTime = daily.totalBreakTime || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            
            // 番茄钟评分 (50分)
            const idealPomodoros = 8.0;
            const pomodoroScore = Math.min(completedPomodoros / idealPomodoros, 1.0) * 50;
            
            // 休息平衡评分 (30分)
            const workBreakRatio = totalWorkTime > 0 ? totalBreakTime / totalWorkTime : 0;
            const idealBreakRatio = 0.25;
            const breakScore = Math.min(workBreakRatio / idealBreakRatio, 1.0) * 30;
            
            // 一致性评分 (20分)
            const consistencyScore = cancelledBreakCount === 0 ? 20.0 : Math.max(0, 20 - cancelledBreakCount * 5);
            
            const finalScore = pomodoroScore + breakScore + consistencyScore;
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">番茄钟评分：</span>
                    <span class="step-value">${pomodoroScore.toFixed(1)} 分 (${completedPomodoros}/8 × 50)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">工作休息比例：</span>
                    <span class="step-value">${(workBreakRatio * 100).toFixed(1)}% (理想25%)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">休息平衡评分：</span>
                    <span class="step-value">${breakScore.toFixed(1)} 分</span>
                </div>
                <div class="process-step">
                    <span class="step-label">一致性评分：</span>
                    <span class="step-value">${consistencyScore.toFixed(1)} 分 (取消休息${cancelledBreakCount}次)</span>
                </div>
                <div class="final-result">
                    最终得分：${Math.round(finalScore)} 分
                </div>
            `;
        }
        
        // 专注度计算过程
        function showFocusCalculation(daily) {
            const container = document.querySelector('#focusCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            const screenLockCount = daily.screenLockCount || 0;
            
            const baseScore = completedPomodoros * 10;
            const interruptionPenalty = (cancelledBreakCount + screenLockCount) * 5;
            const finalScore = Math.max(0, Math.min(100, baseScore - interruptionPenalty));
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">基础得分：</span>
                    <span class="step-value">${baseScore} 分 (${completedPomodoros} × 10)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">取消休息次数：</span>
                    <span class="step-value">${cancelledBreakCount} 次</span>
                </div>
                <div class="process-step">
                    <span class="step-label">息屏次数：</span>
                    <span class="step-value">${screenLockCount} 次</span>
                </div>
                <div class="process-step">
                    <span class="step-label">中断惩罚：</span>
                    <span class="step-value">-${interruptionPenalty} 分 ((${cancelledBreakCount} + ${screenLockCount}) × 5)</span>
                </div>
                <div class="final-result">
                    最终得分：${Math.round(finalScore)} 分
                </div>
            `;
        }
        
        // 健康度计算过程
        function showHealthCalculation(daily) {
            const container = document.querySelector('#healthCalculationProcess .process-steps');
            if (!container) return;
            
            const completedPomodoros = daily.completedPomodoros || 0;
            const totalWorkTime = daily.totalWorkTime || 0;
            const stayUpLateCount = daily.stayUpLateCount || 0;
            const cancelledBreakCount = daily.cancelledBreakCount || 0;
            
            // 如果没有任何活动，返回较低的基础分数
            if (completedPomodoros === 0 && totalWorkTime === 0) {
                container.innerHTML = `
                    <div class="process-step">
                        <span class="step-label">活动状态：</span>
                        <span class="step-value">无工作记录</span>
                    </div>
                    <div class="final-result">
                        基础得分：20 分
                    </div>
                `;
                return;
            }
            
            let score = 100.0;
            const stayUpPenalty = stayUpLateCount * 20;
            const breakPenalty = cancelledBreakCount * 5;
            const overtimePenalty = totalWorkTime > 8 * 60 * 60 ? 20 : 0;
            
            score -= stayUpPenalty;
            score -= breakPenalty;
            score -= overtimePenalty;
            
            const finalScore = Math.max(0, score);
            
            container.innerHTML = `
                <div class="process-step">
                    <span class="step-label">基础分数：</span>
                    <span class="step-value">100 分</span>
                </div>
                <div class="process-step">
                    <span class="step-label">熬夜扣分：</span>
                    <span class="step-value">-${stayUpPenalty} 分 (${stayUpLateCount} × 20)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">取消休息扣分：</span>
                    <span class="step-value">-${breakPenalty} 分 (${cancelledBreakCount} × 5)</span>
                </div>
                <div class="process-step">
                    <span class="step-label">过劳扣分：</span>
                    <span class="step-value">-${overtimePenalty} 分 ${totalWorkTime > 8 * 60 * 60 ? '(工作超过8小时)' : '(工作未超时)'}</span>
                </div>
                <div class="final-result">
                    最终得分：${Math.round(finalScore)} 分
                </div>
            `;
        }
        
        // 显示建议
        function showRecommendations() {
            console.log('Showing recommendations...');
            const recommendations = generateRecommendations();
            console.log('Generated recommendations:', recommendations);
            
            const container = document.getElementById('recommendationsList');
            if (!container) {
                console.error('Recommendations container not found');
                return;
            }
            
            // 清空现有内容，防止重复添加
            container.innerHTML = '';
            
            if (recommendations.length === 0) {
                console.warn('No recommendations generated');
                return;
            }
            
            recommendations.forEach(recommendation => {
                const item = document.createElement('div');
                // 根据建议类型直接分配对应的颜色类
                const typeClassMap = {
                    'work': 'rec-work',
                    'rest': 'rec-rest', 
                    'focus': 'rec-focus',
                    'health': 'rec-health'
                };
                const typeClass = typeClassMap[recommendation.type] || 'rec-health';
                item.className = 'recommendation-item ' + typeClass;
                item.textContent = recommendation.text;
                container.appendChild(item);
            });
            
            console.log('Recommendations displayed successfully');
        }
        
        // 生成建议（带类型信息）
        function generateRecommendations() {
            const daily = reportData.daily;
            const recommendations = [];
            
            console.log('Generating recommendations for daily data:', daily);
            
            if (!daily) {
                console.warn('No daily data available for recommendations');
                return [
                    { text: '📊 欢迎使用番茄钟工作报告！', type: 'health' },
                    { text: '🍅 开始使用番茄钟来记录您的工作数据', type: 'work' }
                ];
            }
            
            const totalWorkTime = daily.totalWorkTime || 0;

            if (daily.workIntensityScore < 50) {
                recommendations.push({ text: '💪 建议增加番茄钟数量，提高工作效率', type: 'work' });
            }
            
            if (daily.restAdequacyScore < 60) {
                recommendations.push({ text: '☕ 休息时间不足，建议严格执行休息计划', type: 'rest' });
            }
            
            // 超过 8 小时工作提醒（与健康度计算中的过劳扣分一致）
            if (totalWorkTime > 8 * 60 * 60) {
                recommendations.push({ text: '⌛ 今日工作超过 8 小时，注意劳逸结合，建议适当休息', type: 'health' });
            }

            if (daily.cancelledBreakCount > 2) {
                recommendations.push({ text: '🎯 频繁取消休息会影响专注度，建议坚持休息', type: 'focus' });
            }
            
            if (daily.stayUpLateCount > 0) {
                recommendations.push({ text: '🌙 检测到熬夜行为，建议调整作息时间', type: 'health' });
            }
            
            if (daily.healthScore >= 80) {
                recommendations.push({ text: '🎉 今日工作状态良好，继续保持！', type: 'health' });
            }
            
            if (daily.focusScore >= 80) {
                recommendations.push({ text: '🏆 专注度很高，工作效率优秀！', type: 'focus' });
            }
            
            if (recommendations.length === 0) {
                if (daily.completedPomodoros === 0) {
                    recommendations.push({ text: '🚀 开始您的第一个番茄钟，建立高效工作习惯！', type: 'work' });
                    recommendations.push({ text: '⏰ 建议设置25分钟专注工作，5分钟休息的节奏', type: 'rest' });
                } else {
                    recommendations.push({ text: '👍 工作状态正常，继续保持良好的工作节奏', type: 'health' });
                }
            }
            
            console.log('Generated recommendations:', recommendations);
            return recommendations;
        }
        
        // 折叠/展开评分计算详情
        function toggleCalculationDetails() {
            const section = document.getElementById('calculationSection');
            const triggerLink = document.getElementById('calculationTriggerLink');
            const triggerIcon = document.getElementById('calculationTriggerIcon');
            
            if (section.style.display === 'none') {
                // 显示详情
                section.style.display = 'block';
                triggerLink.innerHTML = '隐藏评分计算详情 <span class="trigger-icon rotated" id="calculationTriggerIcon">▼</span>';
                
                // 平滑滚动到详情区域
                setTimeout(() => {
                    section.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            } else {
                // 隐藏详情
                section.style.display = 'none';
                triggerLink.innerHTML = '查看评分计算详情 <span class="trigger-icon" id="calculationTriggerIcon">▼</span>';
            }
        }
        
        // 数据检查函数
        function checkReportDataStructure() {
            console.log('🔍 === REPORT DATA STRUCTURE CHECK ===');
            console.log('📊 Full reportData:', reportData);
            
            if (reportData) {
                console.log('✅ reportData exists');
                console.log('📅 Daily data keys:', Object.keys(reportData.daily || {}));
                console.log('📈 Weekly data keys:', Object.keys(reportData.weekly || {}));
                
                if (reportData.weekly && reportData.weekly.heatmapData) {
                    console.log('🔥 Heatmap data exists!');
                    console.log('📊 Heatmap data length:', reportData.weekly.heatmapData.length);
                    console.log('📄 Sample heatmap data:', reportData.weekly.heatmapData.slice(0, 3));
                } else {
                    console.log('❌ No heatmap data found');
                    console.log('🔧 Weekly structure:', reportData.weekly);
                }
            } else {
                console.log('❌ No reportData available');
            }
            console.log('🔍 === END DATA STRUCTURE CHECK ===');
        }
        
        // 计算本周开始日期（周一为一周的开始）
        function getWeekStartDate(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 调整为周一开始
            return new Date(d.setDate(diff));
        }
        
        // 计算应该显示多少天（从本周开始到今天）
        function getDaysToShow(weekStart, today) {
            const diffTime = today.getTime() - weekStart.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 包含今天
            return Math.min(Math.max(diffDays, 1), 7); // 至少显示1天，最多7天
        }
        
        // 检查两个日期是否为同一天
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            // 先检查数据结构
            checkReportDataStructure();
            
            // 然后初始化报告
            initializeReport();

            // 绑定分享按钮
            const shareBtn = document.getElementById('reportShareButton');
            if (shareBtn) {
                shareBtn.addEventListener('click', async function() {
                    try {
                        await generateAndShareScreenshot();
                    } catch (e) {
                        console.error('Share failed:', e);
                    }
                });
            }
        });
        
        // 如果Chart.js加载失败，提供备用初始化
        window.addEventListener('load', function() {
            console.log('Window loaded');
            if (!reportInitialized) {
                console.log('Report not initialized yet, retrying...');
                setTimeout(initializeReport, 1000);
            }
        });

        // 生成页面截图并保存到文件，同时拷贝到剪贴板
        // 这里调用宿主App桥接方法；若不可用则尝试使用浏览器API做退化处理
        function hideShareButton() {
            const btn = document.getElementById('reportShareButton');
            if (btn) { btn.dataset.prevDisplay = btn.style.display || ''; btn.style.display = 'none'; }
        }
        function showShareButton() {
            const btn = document.getElementById('reportShareButton');
            if (btn) { btn.style.display = (btn.dataset.prevDisplay !== undefined) ? btn.dataset.prevDisplay : ''; }
        }
        async function generateAndShareScreenshot() {
            hideShareButton();
            // 给样式应用一点时间，避免被截到
            await new Promise(r => setTimeout(r, 60));

            // 优先使用宿主提供的API（例如 WKWebView 注入）
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.saveReportImage) {
                const payload = { action: 'capture', format: 'png', quality: 0.95 };
                window.webkit.messageHandlers.saveReportImage.postMessage(payload);
                return;
            }

            // 退化实现：使用 CSS Paint（需要 html2canvas 等库，当前项目未引入 -> 提示）
            console.warn('No native bridge available for screenshot. Please integrate native capture.');
            showShareButton();
            alert('当前环境不支持直接截图，请从 App 端实现保存与拷贝。');
        }

        // 原生回调：显示简易的结果提示
        window.__reportShareCallbackFromNative = function(payload) {
            try {
                const data = (typeof payload === 'string') ? JSON.parse(payload) : payload;
                const ok = data && data.status === 'success';
                const msg = ok ? '✅ 已保存并复制到剪贴板' : '❌ 分享失败，请重试';
                showShareButton();
                // 轻量提示（不引入UI库）：使用原生alert，或未来可替换成自定义toast
                alert(msg + (ok && data.filePath ? ('\n文件: ' + data.filePath) : ''));
            } catch (e) {
                console.warn('share callback parse failed', e);
                showShareButton();
            }
        };

        // 健康度达标时播放撒花特效（一次性、轻量实现）
        function triggerConfettiIfHealthy() {
            const daily = reportData && reportData.daily ? reportData.daily : null;
            if (!daily) return;
            const health = Math.round(daily.healthScore || 0);
            if (health < 80) return;
            const host = document.querySelector('.recommendations-section');
            if (!host) return;
            playConfetti(host, { duration: 1200, particles: 80 });
        }

        function playConfetti(container, opts) {
            const duration = (opts && opts.duration) || 1200;
            const particles = (opts && opts.particles) || 80;
            const canvas = document.createElement('canvas');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            canvas.style.position = 'absolute';
            canvas.style.left = '0';
            canvas.style.top = '0';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '10';
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            const colors = ['#ed347c', '#b2fd00', '#04f6d1', '#cc66ff', '#f59e0b'];
            const pieces = [];
            for (let i = 0; i < particles; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: -10 - Math.random() * 30,
                    size: 4 + Math.random() * 6,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speedY: 1 + Math.random() * 2.5,
                    speedX: -1 + Math.random() * 2,
                    rotation: Math.random() * Math.PI,
                    rotationSpeed: -0.2 + Math.random() * 0.4
                });
            }
            let start = performance.now();
            function frame(now) {
                const elapsed = now - start;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.rotation += p.rotationSpeed;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                if (elapsed < duration) {
                    requestAnimationFrame(frame);
                } else {
                    container.removeChild(canvas);
                }
            }
            requestAnimationFrame(frame);
        }
    </script>
</body>
</html>


