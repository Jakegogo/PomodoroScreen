# PomodoroScreen - 番茄钟计时器

一款功能丰富且高度可定制的 macOS 番茄钟计时应用，集成智能休息提醒、自动重启管理、个性化背景设置和优雅动画效果，旨在提升工作效率的同时，关注用户的身体健康和使用体验。

## 功能特点

### 🍅 状态栏显示
- 在 macOS 状态栏显示剩余时间
- 番茄钟图标 + 倒计时显示
- 右键菜单控制：开始/停止/重置/设置/退出
- 智能状态指示：运行中/暂停/空闲状态

### ⏰ 计时功能
- **可定制时长**：番茄钟时间（默认25分钟）和休息时间（默认3分钟）
- **长休息计划**：每N个番茄钟后自动触发长休息（默认每2次，5分钟）
- **累积休息时间**：支持将中断的短休息时间累加到长休息
- 精确到秒的倒计时显示
- 自动计时完成检测

### 🔒 智能全屏遮罩
当计时结束时，应用会显示一个功能丰富的全屏遮罩层：
- **半透明效果**：可以看到底下的桌面内容
- **个性化背景**：支持图片（JPG/PNG/GIF）和视频（MP4/MOV/AVI）背景
- **背景轮播**：多个背景文件按顺序在不同休息期间轮播显示
- **视频播放控制**：支持0.1x-8.0x播放速率调节
- **优雅动画效果**：
  - 提示文字3秒后淡出消失
  - 取消按钮淡化到40%透明度但保持可点击
  - 鼠标悬停时按钮恢复完全不透明
- **取消按钮**：可配置显示/隐藏，位于屏幕下方（类似iOS锁屏位置）
- **自动恢复**：3分钟后自动隐藏，恢复正常工作
- 覆盖整个屏幕，防止切换应用或桌面

### ⚙️ 丰富的设置选项

#### 基础设置
- 自动启动番茄钟（默认开启）
- 番茄钟时长设置（1-60分钟，默认25分钟）
- 休息时长设置（1-30分钟，默认3分钟）
- 取消休息按钮显示控制

#### 自动处理
- **无操作检测**：X分钟无操作时自动暂停/重启计时器（默认10分钟）
- **锁屏检测**：进入锁屏时自动暂停/重启计时器
- **屏保检测**：进入屏保时自动暂停/重启计时器
- **智能恢复**：解锁或退出屏保时从暂停点继续计时

#### 计划管理
- **长休息周期**：设置每几个番茄钟后进行长休息（2-10次）
- **长休息时长**：设置长休息的持续时间（5-30分钟）
- **长休息按钮**：独立控制长休息期间的取消按钮显示
- **时间累积**：将中断的短休息时间自动累加到下次长休息

#### 背景设置
- **文件管理**：添加、删除、排序背景文件
- **格式支持**：图片（JPG、PNG、GIF）和视频（MP4、MOV、AVI）
- **预览功能**：背景文件列表显示缩略图预览
- **播放控制**：视频文件支持播放速率调节（0.1x-8.0x）
- **轮播模式**：多个背景按顺序在不同休息期间显示

### 🤖 智能状态机管理
- 基于状态机模式的自动重启逻辑
- 智能区分不同类型的暂停状态（无操作、锁屏、屏保）
- 防止重复事件触发和状态冲突
- 精确的时间恢复和状态同步

## 如何使用

### 构建应用
1. 在 Xcode 中打开 `PomodoroScreen.xcodeproj`
2. 选择目标设备为 "My Mac"
3. 点击运行按钮或按 `Cmd+R`

### 使用应用

#### 基本操作
1. 应用启动后会在状态栏显示 🍅 25:00
2. 右键点击状态栏图标打开菜单
3. 选择"开始"启动番茄钟计时
4. 计时结束后会显示全屏遮罩提醒休息

#### 休息管理
5. **短休息**（默认3分钟）：
   - 提示文字显示3秒后自动淡出
   - 取消按钮淡化但保持可用，鼠标悬停时恢复清晰
   - 点击"取消休息"按钮立即结束休息
   - 或等待时间结束自动恢复工作

6. **长休息**（每2个番茄钟后，默认5分钟）：
   - 自动触发，时长更长
   - 可配置是否显示取消按钮
   - 如启用累积功能，会包含之前中断的短休息时间

#### 设置配置
7. 右键菜单选择"设置"打开配置面板：
   - **基础设置**：调整番茄钟和休息时间、自动启动等
   - **自动处理**：配置无操作、锁屏、屏保时的行为
   - **计划**：设置长休息周期和时间累积
   - **背景**：添加个性化的图片或视频背景

### 测试功能
- **立即完成（测试）**: 右键菜单中的测试选项，可以立即触发遮罩层显示
- 用于快速验证遮罩层功能、背景设置和动画效果

## 技术实现

### 核心组件
- `PomodoroTimer`: 计时器核心逻辑，支持长短休息计划和时间累积
- `StatusBarController`: 状态栏控制和菜单管理
- `OverlayWindow`: 全屏遮罩窗口，支持背景媒体和动画效果
- `SettingsWindow`: 多标签页设置界面，包含基础、自动处理、计划、背景配置
- `AutoRestartStateMachine`: 智能状态机，管理自动暂停/恢复逻辑
- `AppDelegate`: 应用程序生命周期和设置持久化管理

### 关键技术特性
- **LSUIElement**: 应用不在 Dock 中显示，只在状态栏运行
- **NSWindow.Level.screenSaver**: 确保遮罩窗口在最高层级
- **collectionBehavior**: 遮罩窗口覆盖所有桌面空间
- **AVFoundation**: 视频背景播放和缩略图生成
- **Core Animation**: 优雅的淡入淡出和悬停动画效果
- **NSTrackingArea**: 精确的鼠标悬停检测
- **DistributedNotificationCenter**: 系统锁屏和屏保事件监听
- **NSEvent.addGlobalMonitorForEvents**: 全局鼠标键盘活动监测
- **UserDefaults**: 设置数据持久化存储
- **State Machine Pattern**: 复杂状态管理的设计模式实现

### 测试架构
- **XCTest**: 完整的单元测试覆盖
- **状态机测试**: 19个单元测试验证自动重启逻辑
- **集成测试**: 验证计时器与系统事件的交互
- **计划功能测试**: 验证长休息周期和时间累积逻辑

## 系统要求

- macOS 14.0 或更高版本
- Xcode 15.0 或更高版本（用于构建）

## 注意事项

⚠️ **重要提醒**: 
- 遮罩层激活时会阻止所有其他应用程序的使用
- 建议先使用"立即完成（测试）"功能熟悉界面和操作
- 确保在重要工作前测试应用行为和背景设置
- 如遇问题，可通过 Activity Monitor 强制退出应用
- 视频背景文件较大时可能影响启动速度，建议优化文件大小

💡 **使用建议**:
- 合理设置长休息周期，避免过于频繁的长时间休息
- 利用背景轮播功能添加多样化的休息内容
- 根据工作环境调整自动处理设置（锁屏、屏保、无操作检测）
- 定期清理不需要的背景文件以优化性能

## 版本历史

### v2.0.0 (当前版本)
- ✨ 新增多标签页设置界面
- 🎯 实现长休息计划和时间累积功能
- 🖼️ 支持个性化图片和视频背景
- 🎬 添加视频播放速率控制
- ✨ 优雅的动画效果和鼠标悬停交互
- 🤖 智能状态机管理自动重启逻辑
- 🧪 完整的单元测试覆盖

### v1.0.0
- 🍅 基础番茄钟计时功能
- 📊 状态栏显示和菜单控制
- 🔒 全屏遮罩休息提醒
- ⚙️ 基本设置选项

## 许可证

此项目仅供学习和个人使用。
