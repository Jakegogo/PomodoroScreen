# 屏幕检测功能自动化测试说明

## 📋 测试概述

本测试套件专门用于验证PomodoroScreen应用的屏幕检测和会议模式自动切换功能。通过Mock框架模拟各种投屏和外接显示器场景，确保功能的可靠性和稳定性。

## 🏗️ 测试架构

### Mock框架
```
MockScreenDetectionManager
├── 模拟屏幕配置变化
├── 模拟投屏连接/断开
├── 模拟外接显示器连接/断开
└── 模拟各种分辨率场景
```

### 测试分层
```
AutomatedTestRunner (测试套件运行器)
├── ScreenDetectionIntegrationTests (屏幕检测集成测试)
├── MeetingModeAutoSwitchTests (会议模式自动切换测试)
└── 性能和边界条件测试
```

## 🧪 测试用例

### 1. 屏幕检测基础功能测试 (`ScreenDetectionIntegrationTests`)

#### 基础检测测试
- **testScreenDetection_SingleScreen**: 验证单屏状态检测
- **testScreenDetection_ExternalMonitor**: 验证外部显示器检测
- **testScreenDetection_Screencasting**: 验证投屏状态检测

#### 自动会议模式测试
- **testAutoMeetingMode_EnabledOnScreencast**: 验证投屏时自动启用会议模式
- **testAutoMeetingMode_DisabledWhenAutoDetectionOff**: 验证禁用自动检测时的行为

#### 端到端集成测试
- **testFullIntegration_ConnectAndDisconnectScreencast**: 完整的连接/断开流程测试
- **testFullIntegration_MultipleScreenChanges**: 多次屏幕变化测试

#### 边界条件测试
- **testEdgeCase_CommonProjectionResolutions**: 常见投屏分辨率测试
- **testEdgeCase_RapidScreenChanges**: 快速屏幕变化测试

### 2. 会议模式自动切换测试 (`MeetingModeAutoSwitchTests`)

#### 自动启用测试
- **testAutoEnable_OnExternalMonitorConnect**: 外部显示器连接时自动启用
- **testAutoEnable_OnScreencastConnect**: 投屏连接时自动启用
- **testAutoEnable_SkipWhenAlreadyEnabled**: 已启用时跳过重复启用
- **testAutoEnable_SkipWhenAutoDetectionDisabled**: 禁用自动检测时跳过

#### 自动关闭测试
- **testAutoDisable_OnExternalScreenDisconnect**: 外部屏幕断开时自动关闭
- **testAutoDisable_SkipWhenManuallyEnabled**: 手动启用时跳过自动关闭

#### 复杂场景测试
- **testComplexScenario_MultipleConnectDisconnect**: 多次连接断开场景
- **testComplexScenario_ManualOverrideAutomatic**: 手动覆盖自动设置场景

### 3. 自动化测试运行器 (`AutomatedTestRunner`)

#### 完整测试套件
- **testScreenDetectionFullSuite**: 执行所有测试场景并生成报告

#### 测试场景覆盖
- 基础屏幕检测功能
- 会议模式自动切换
- 边界条件处理
- 性能基准测试
- 端到端集成测试

## 🚀 运行测试

### 方法一：使用测试脚本（推荐）
```bash
# 在项目根目录执行
./run_screen_detection_tests.sh
```

### 方法二：使用Xcode命令行
```bash
# 运行屏幕检测集成测试
xcodebuild test -scheme PomodoroScreen \
  -destination 'platform=iOS Simulator,name=iPhone 16' \
  -only-testing "PomodoroScreenTests/ScreenDetectionIntegrationTests"

# 运行会议模式自动切换测试
xcodebuild test -scheme PomodoroScreen \
  -destination 'platform=iOS Simulator,name=iPhone 16' \
  -only-testing "PomodoroScreenTests/MeetingModeAutoSwitchTests"

# 运行完整自动化测试套件
xcodebuild test -scheme PomodoroScreen \
  -destination 'platform=iOS Simulator,name=iPhone 16' \
  -only-testing "PomodoroScreenTests/AutomatedTestRunner"
```

### 方法三：使用Xcode IDE
1. 打开PomodoroScreen.xcodeproj
2. 选择测试导航器 (⌘6)
3. 展开PomodoroScreenTests
4. 右键点击测试类或方法，选择"Run"

## 📊 测试报告

### 自动生成报告
测试脚本会自动生成以下内容：
- **测试报告**: `TestResults/test_report_YYYYMMDD_HHMMSS.md`
- **构建日志**: `TestResults/build.log`
- **测试日志**: `TestResults/*_tests.log`

### 报告内容
- 测试结果概览
- 功能覆盖情况
- 详细测试结果
- 性能基准数据
- 错误日志和调试信息

## 🎯 Mock场景

### 屏幕配置模拟
```swift
// 单屏状态
mockScreenDetection.simulateResetToSingleScreen()

// 外部显示器连接
mockScreenDetection.simulateExternalScreenConnected(width: 2560, height: 1440)

// 投屏场景
mockScreenDetection.simulateScreencasting(mirrorResolution: true)

// 断开外部屏幕
mockScreenDetection.simulateExternalScreenDisconnected()
```

### 支持的投屏分辨率
- 1920×1080 (Full HD)
- 1280×720 (HD)
- 1024×768 (XGA)
- 1280×800 (WXGA)
- 1366×768 (常见笔记本)
- 1600×900 (HD+)
- 1440×900 (WXGA+)
- 1680×1050 (WSXGA+)

## 🔧 测试配置

### UserDefaults键值
```swift
// 会议模式设置
"MeetingModeEnabled": Bool          // 会议模式是否启用
"MeetingModeAutoEnabled": Bool      // 是否为自动启用
"AutoDetectScreencastEnabled": Bool // 自动检测投屏是否启用
```

### Mock回调机制
```swift
mockScreenDetection.onScreenConfigurationChanged = { hasExternalScreen in
    // 处理屏幕配置变化
}
```

## ⚡ 性能基准

### 检测操作性能
- **目标**: 1000次检测操作在1秒内完成
- **测试方法**: `testPerformance_ScreenDetection`
- **验证指标**: 响应时间、内存使用、CPU占用

### 快速切换处理
- **场景**: 5次快速连接/断开循环
- **验证**: 所有事件正确处理，状态一致

## 🐛 调试支持

### 日志输出
所有Mock操作都会输出详细日志：
```
📺 [Mock] 模拟外部屏幕连接: 1920x1080
📺 [Mock] 屏幕检测: 总屏幕数 2, 外部屏幕: true
📺 [Mock] 检测到投屏/外接显示器，自动启用会议模式
```

### 测试状态跟踪
- 屏幕配置变化计数
- 会议模式切换次数
- UserDefaults状态验证
- 回调执行验证

## 📝 扩展测试

### 添加新测试用例
1. 继承现有测试类或创建新的测试类
2. 使用`MockScreenDetectionManager`模拟场景
3. 验证预期行为和状态变化
4. 添加到`AutomatedTestRunner`中

### 自定义Mock场景
```swift
// 创建自定义分辨率场景
mockScreenDetection.simulateExternalScreenConnected(width: 3440, height: 1440)

// 模拟特殊投屏场景
mockScreenDetection.simulateScreencasting(mirrorResolution: false)
```

## ✅ 验收标准

### 功能正确性
- [ ] 所有屏幕检测测试通过
- [ ] 会议模式自动切换正常
- [ ] 边界条件处理正确
- [ ] 状态一致性验证通过

### 性能要求
- [ ] 检测操作响应时间 < 1ms
- [ ] 1000次操作总时间 < 1s
- [ ] 快速切换场景稳定

### 稳定性要求
- [ ] 连续测试无崩溃
- [ ] 内存使用稳定
- [ ] 状态管理一致

---

*该测试套件确保屏幕检测和会议模式功能在各种场景下都能可靠工作，为用户提供稳定的使用体验。*
