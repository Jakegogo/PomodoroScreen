# 自动检测投屏功能说明

## 📋 功能概述

自动检测投屏功能可以在检测到投屏或连接外接显示器时，自动启用会议模式，确保在演示或会议期间不会显示干扰性的休息提醒。

## 🔍 检测机制

### 屏幕检测逻辑
- **基础检测**：监测系统连接的屏幕数量，当检测到多于一个屏幕时触发
- **镜像检测**：识别相同或相似分辨率的屏幕，判断是否为投屏镜像
- **投屏分辨率识别**：检测常见的投影仪和会议室显示器分辨率

### 支持的投屏分辨率
- 1920×1080 (Full HD)
- 1280×720 (HD)
- 1024×768 (XGA)
- 1280×800 (WXGA)
- 1366×768 (常见笔记本分辨率)
- 1600×900 (HD+)
- 1440×900 (WXGA+)
- 1680×1050 (WSXGA+)

## ⚙️ 设置选项

### 自动检测开关
- **位置**：设置面板 → 自动处理 → "检测到投屏/外接显示器时自动启用会议模式"
- **默认状态**：开启
- **功能**：控制是否启用自动检测投屏功能

### 会议模式开关
- **位置**：状态栏弹窗底部
- **功能**：手动控制会议模式的开启/关闭
- **自动更新**：当检测到投屏变化时，开关会自动更新状态

## 🔄 自动切换逻辑

### 自动启用会议模式
**触发条件**：
1. 自动检测投屏功能已开启
2. 检测到外接显示器或投屏
3. 当前会议模式未开启

**执行动作**：
- 自动启用会议模式
- 在UserDefaults中标记为自动启用 (`MeetingModeAutoEnabled = true`)
- 更新弹窗中的会议模式开关状态

### 自动关闭会议模式
**触发条件**：
1. 投屏/外接显示器已断开
2. 当前会议模式为自动启用状态

**执行动作**：
- 自动关闭会议模式
- 清除自动启用标记 (`MeetingModeAutoEnabled = false`)
- 更新弹窗中的会议模式开关状态

**注意**：如果会议模式是手动开启的，断开投屏时不会自动关闭

## 🎯 会议模式效果

### 静默休息
- 休息期间不显示全屏遮罩层
- 不显示右上角的休息提醒tooltip
- 在状态栏显示"休息时间"文字提示

### 正常工作
- 番茄钟计时正常进行
- 状态栏图标正常显示倒计时
- 所有其他功能不受影响

## 💡 使用场景

### 适用场景
- 📊 商务演示和会议
- 🎓 教学和培训
- 💻 屏幕共享和远程协作
- 🖥️ 外接显示器工作

### 优势
- **无干扰**：避免在重要场合显示休息提醒
- **自动化**：无需手动切换，智能识别工作环境
- **灵活性**：支持手动控制和自动检测两种模式

## 🔧 技术实现

### 核心组件
- `ScreenDetectionManager`：屏幕检测管理器
- `AppDelegate`：集成自动切换逻辑
- `StatusBarController`：状态栏显示控制
- `SettingsWindow`：设置界面集成

### 监听机制
- 使用 `NSApplication.didChangeScreenParametersNotification` 监听屏幕配置变化
- 实时检测屏幕连接/断开事件
- 延迟处理确保屏幕配置稳定

### 数据存储
- `AutoDetectScreencastEnabled`：自动检测功能开关状态
- `MeetingModeEnabled`：会议模式开启状态
- `MeetingModeAutoEnabled`：标记是否为自动启用

## 🐛 调试信息

### 日志输出
```
📺 屏幕检测: 总屏幕数 2, 外部屏幕: true
📺 屏幕 0: 1920x1080 (主屏幕)
📺 屏幕 1: 1920x1080 (外部屏幕)
📺 检测到投屏/外接显示器，自动启用会议模式
🔇 会议模式开关状态已自动更新: 开启
```

### 状态检查
- 屏幕数量和分辨率信息
- 自动检测功能状态
- 会议模式切换日志
- 用户手动操作记录

## ⚠️ 注意事项

1. **兼容性**：支持 macOS 10.15 及以上版本
2. **权限**：无需额外系统权限
3. **性能**：使用系统通知机制，对性能影响极小
4. **准确性**：基于屏幕配置检测，准确率较高但可能存在误判
5. **手动优先**：用户手动设置的会议模式优先级高于自动检测

---

*该功能旨在提升用户在专业场景下的使用体验，通过智能检测减少手动操作的需要。*
